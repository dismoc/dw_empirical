library('zoo')
library('fixest')
library('timeDate')
library('DescTools')
library('summarytools')
library(gtools)
library('fuzzyjoin')
library('lubridate')
library('xtable')
# Merging the data tables ----
effr <- read_csv("D:/Research/DW lending empirical/Data/effr_range.csv")
dwborrow <- read_csv("D:/Research/DW lending empirical/Data/dwborrow.csv")
call_rep <- read_csv("D:/Research/DW lending empirical/Data/call_rep_full.csv")
int_rate <- read_excel("D:/Research/DW lending empirical/Data/int_rates.xls")
sdc <- read_csv("D:/Research/DW lending empirical/Data/sdc_full.csv")
def <- read_csv("D:/Research/DW lending empirical/Data/defs.csv")
inst <-read_csv("D:/Research/DW lending empirical/Data/INSTITUTIONS2.CSV")
att <- read_csv("D:/Research/DW lending empirical/Data/ffiec/Atrributes_merged.csv")
int_rate$Date <- as.Date(int_rate$Date)
q <- c("0331","0630","0930","1231")
y <- c("2010","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020")
dwbsub <- subset(dwborrow, Type.of.credit == "Primary Credit")
dwbsub <- subset(dwbsub, dwbsub$Loan.amount >= 1000000)
dwbsub$Date <- data.frame(timeLastDayInQuarter(dwbsub$Loan.date, format = "%Y-%m-%d", zone = "", FinCenter = ""))$GMT.x..i..
dwbsub$repay <- (dwbsub$Interest.rate*dwbsub$Term/36000)*dwbsub$Loan.amount
dcomb <- merge(merge(aggregate(Term ~ Borrower.ABA.number + Date, data = dwbsub, FUN = sum),
aggregate(Loan.amount*Term ~ Borrower.ABA.number + Date, data = dwbsub, FUN = sum)),
aggregate(repay ~ Borrower.ABA.number + Date, data = dwbsub, FUN = sum))
rm(dwbsub, dwborrow)
dcomb$avg.int <- 36000*dcomb$repay/dcomb$`Loan.amount * Term`
setnames(dcomb, old = c('Borrower.ABA.number','Date','Term','Loan.amount * Term','repay','avg.int'),
new = c('ABA_routing','Date','dw_freq','dw_quant','repay','avg_int'))
dcomb$ABA_routing <- as.numeric(dcomb$ABA_routing)
att$ABA_routing <- att$ID_ABA_PRIM; att$IDRSSD <- att$`#ID_RSSD`
dc <- left_join(dcomb, att[,c('ABA_routing','IDRSSD','D_DT_START','ID_FDIC_CERT','ID_OCC')], by = c('ABA_routing'))
inst$IDRSSD <- inst$FED_RSSD
df <- call_rep %>% left_join(inst[,c('FED','FDICREGN','IDRSSD','OFFICES','BKCLASS','OFFDOM','OFFFOR','STMULT','CHRTAGNT','ESTYMD')], by=('IDRSSD'),
suffix = c("",".y")) %>% select(-ends_with(".y"), -contains("..."))
df <- df %>% full_join(sdc, by=c('IDRSSD','Date'), suffix = c("",".y")) %>% select(-ends_with(".y"), -contains("..."))
rm(sdc)
df <- df %>% left_join(dc, by=c('IDRSSD','Date'), suffix = c("",".y")) %>% select(-ends_with(".y"), -contains("..."))
rm(dc, dcomb, att)
rm(inst, call_rep)
# Adding new columns ----
# Two types of access definition, dwaccess_2 is access after first loan, dwaccess_1 is access for all sample time period
#dwaccess_1
ag <- aggregate(dw_freq ~ IDRSSD, data=df, FUN = sum, na.rm = TRUE)
setnames(ag, old=c('dw_freq'), new=c('freq'))
df1 <- left_join(df, ag)
df1$dwaccess_1 <- ifelse(df1$freq > 0, 1, 0)
df1$dwaccess_1[is.na(df1$dwaccess_1)] = 0
df1 <- df1[ , -which(names(df1) %in% c("freq"))]
df <- df1
rm(df1,ag)
#dwaccess_2
df1 = df %>%
arrange(IDRSSD,Date) %>%
group_by(IDRSSD) %>%
mutate(agg_access =rollapplyr(dw_freq, 60, sum, partial = TRUE, na.rm = TRUE) )
df1$dwaccess_2 <- ifelse(df1$agg_access > 0, 1, 0)
df1 <- df1[ , -which(names(df1) %in% c("agg_access"))]
df <- df1
rm(df1)
#Adding additional series - reserve asset ratio and reserve deposit ratio,
df$dw_freq[is.na(df$dw_freq)] <- 0
df$dwborrow_bin <- ifelse(df$dw_freq > 0, 1, 0)
df$reserve_asset_ratio <- df$RCON0010/df$RCON2170
df$reserve_deposit_ratio <- df$RCON0010/df$RCON2200
df[is.infinite(df$reserve_deposit_ratio),c('reserve_deposit_ratio')] <- NA
df$reserve_deposit_ratio <- Winsorize(df$reserve_deposit_ratio, probs = c(.01,.99), na.rm = TRUE)
df$dwborrow_cov <- ifelse(df$dwborrow_bin == 1 & as.Date(df$Date) >= as.Date('2020-03-31'), 1, 0)
# dwaccess_cov
ag <- aggregate(dwborrow_cov ~ IDRSSD, data=df, FUN = sum, na.rm = TRUE)
setnames(ag, old=c('dwborrow_cov'), new=c('freq_cov'))
df1 <- left_join(df, ag)
df1$dwaccess_cov <- ifelse(df1$freq_cov > 0, 1, 0)
df1$dwaccess_cov[is.na(df1$dwaccess_cov)] = 0
df1 <- df1[ , -which(names(df1) %in% c("freq_cov"))]
df <- df1
rm(df1,ag)
# pppaccess_cov
ag <- aggregate(RCONLG26 ~ IDRSSD, data=df, FUN = sum, na.rm = TRUE)
setnames(ag, old=c('RCONLG26'), new=c('ppp_quant_cov'))
df1 <- left_join(df, ag)
df1$pppaccess_cov <- ifelse(df1$freq_cov > 0, 1, 0)
df1$pppaccess_cov[is.na(df1$dwaccess_cov)] = 0
df <- df1
rm(df1,ag)
rm(effr, int_rate)
aggregate(RCON0010 ~ Date, df)
aggregate(RCON0010 ~ Date, df, sum)
aggregate(RCON0010 ~ Date, df, sum)[42,2]
sf
View(sf)
sf$cumu = 4075359310000 + sf$cumu
sf
View(sf)
sf$cum_quant_avg <- rollapply(sf$cumu, 7, mean, na.rm=TRUE, fill = NA, partial=4)
.sf
sf
View(sf)
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(cum_quant_avg), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
feols(Loan.amount ~ cumu, sf)
feols(log(Loan.amount) ~ log(cumu), sf)
sf$cumu-4075359310000
ggplot(sf) +
geom_line(aes(x = DateApproved, y = cum_quant_avg, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
sf$cum_quant_avg <- rollapply(sf$cumu, 7, mean, na.rm=TRUE, fill = NA, partial=4)
sf
ggplot(sf) +
geom_line(aes(x = DateApproved, y = cum_quant_avg, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
View(sf)
sf$cumu = -4075359310000 + sf$cumu
sf$cumu
sf$cum_quant_avg <- rollapply(sf$cumu, 7, mean, na.rm=TRUE, fill = NA, partial=4)
ggplot(sf) +
geom_line(aes(x = DateApproved, y = cum_quant_avg, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
View(sf)
3.036337e+09 + -6933624400
feols(dw_quant_avg ~ cumu, sf)
feols(log(dw_quant_avg) ~ log(-cumu), sf)
aggregate(RCON0010 ~ Date, df)
aggregate(RCON0010 ~ Date, df, sum)
aggregate(RCON2200 ~ Date, df, sum)
feols(log(dw_quant_avg) ~ -log(abs(cumu)), sf)
feols(log(Loan.amount) ~ -log(abs(cumu)), sf)
abs(sf$cumu)
-log(abs(sf$cumu))
feols(log(Loan.amount) ~ -log(abs(cumu)), sf)
feols(log(Loan.amount) ~ sign(cumu)*log(abs(cumu)), sf)
feols(log(Loan.amount) ~ sign(cumu)log(abs(cumu)), sf)
feols(log(Loan.amount) ~ log(abs(cumu)), sf)
feols(log(Loan.amount) ~ log(abs(cumu)), sf, se = 'white')
feols(log(Loan.amount) ~ log(abs(cumu)) + log(InitialApprovalAmount) + log(Original.Outstanding.Advance.Amount), sf, se = 'white')
feols(log(Loan.amount) ~ log(InitialApprovalAmount) + log(Original.Outstanding.Advance.Amount), sf, se = 'white')
feols(log(Loan.amount) ~ log(InitialApprovalAmount) , sf, se = 'white')
ggplot(sf) +
geom_line(aes(x = DateApproved, y = cum_quant_avg, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(quant_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 7, mean, na.rm=TRUE, fill = NA, partial=4)
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = quant_week_avg/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = ppp_week_avg/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 7, mean, na.rm=TRUE, fill = NA, partial=5)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 7, mean, na.rm=TRUE, fill = NA, partial=5)
sf$cum_quant_avg <- rollapply(sf$cumu, 7, mean, na.rm=TRUE, fill = NA, partial=5)
sf$tchange_avg <- rollapply(sf$tot_change, 7, mean, na.rm=TRUE, fill = NA, partial=5)
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = ppp_week_avg/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = cum_quant_avg, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = cum_quant_avg, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(subset(sf, as.Date(DateApproved) >= as.Date('2020-03-26') &as.Date(DateApproved) <= as.Date('2020-08-26'))) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(subset(sf, as.Date(DateApproved) >= as.Date('2020-03-26') &as.Date(DateApproved) <= as.Date('2020-08-16'))) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(subset(sf, as.Date(DateApproved) >= as.Date('2020-03-26') &as.Date(DateApproved) <= as.Date('2020-08-10'))) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 10, mean, na.rm=TRUE, fill = NA, partial=5)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 10, mean, na.rm=TRUE, fill = NA, partial=5)
sf$cum_quant_avg <- rollapply(sf$cumu, 10, mean, na.rm=TRUE, fill = NA, partial=5)
sf$tchange_avg <- rollapply(sf$tot_change, 10, mean, na.rm=TRUE, fill = NA, partial=5)
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(subset(sf, as.Date(DateApproved) >= as.Date('2020-03-26') &as.Date(DateApproved) <= as.Date('2020-08-10'))) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
cor(sf$ppp_week_avg,sf$dw_quant_avg, 'complete')
cor(log(sf$ppp_week_avg),log(sf$dw_quant_avg), 'complete')
cor(log(sf$ppp_week_avg+1),log(sf$dw_quant_avg+1), 'complete')
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = ppp_week_avg/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 3, mean, na.rm=TRUE, fill = NA, partial=3)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 3, mean, na.rm=TRUE, fill = NA, partial=3)
sf$cum_quant_avg <- rollapply(sf$cumu, 3, mean, na.rm=TRUE, fill = NA, partial=3)
sf$tchange_avg <- rollapply(sf$tot_change, 3, mean, na.rm=TRUE, fill = NA, partial=3)
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$cum_quant_avg <- rollapply(sf$cumu, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$tchange_avg <- rollapply(sf$tot_change, 5, mean, na.rm=TRUE, fill = NA, partial=3)
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(subset(sf, as.Date(DateApproved) >= as.Date('2020-03-26') &as.Date(DateApproved) <= as.Date('2020-08-10'))) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
View(sf)
ppb <- read_csv("D:/Research/DW lending empirical/Data/ppp_daily.csv")
dwborrow <- read_csv("D:/Research/DW lending empirical/Data/dwborrow.csv")
pplf <- read_csv("D:/Research/DW lending empirical/Data/ppplf_full.csv")
# Aggregate Data 1: Correlation between dw borrowing and aggregate ppp loans-------
# Transformation
ppb2<- aggregate(Original.Outstanding.Advance.Amount ~ Date.Of.Advance, pplf, sum)
sf <- full_join(ppb, ppb2, by=c('DateApproved' = 'Date.Of.Advance'))
sf <- sf[order(sf$DateApproved),]
sf[is.na(sf)] <- 0
sf$tot_change <- sf$Original.Outstanding.Advance.Amount - sf$InitialApprovalAmount
sf$cumu <- cumsum(sf[, 'tot_change'])
dwborrow1 <- dwborrow %>% count(Loan.date)
dwborrow2 <- aggregate(Loan.amount ~ Loan.date, dwborrow, FUN = sum)
dwborrow1 <- subset(full_join(dwborrow2,dwborrow1), as.Date(Loan.date) >= as.Date('2020-01-01'))
sf <- full_join(sf,dwborrow1, by=c('DateApproved' = 'Loan.date')) %>% select(-contains("..."))
sf <- subset(sf, as.Date(DateApproved) <= as.Date('2020-10-01'))
sf <- sf[order(sf$DateApproved),]
ind <- which(is.na(sf$n) == TRUE)
for (i in 2:length(ind)) {
if (ind[i] == ind[i-1]+1) {
ind <- ind[-i]
}
print(length(ind))
}
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
ind <- ind[1:length(ind)-1]
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
sf[ind-1,'InitialApprovalAmount'] <- sf[ind-1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
rm(ind, dwborrow1, dwborrow2)
sf
View(sf)
IsZero(sf$InitialApprovalAmount)
sf[IsZero(sf$InitialApprovalAmount),
]
sf[IsZero(sf$InitialApprovalAmount),'InitialApprovalAmount']
sf[sf$InitialApprovalAmount != 0,]
sf <- sf[sf$InitialApprovalAmount != 0,]
sf$cumu <- sf$cumu$tot_change
sf$cumu_init <- 4075359310000 + sf$cumu
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, sf$InitialApprovalAmount)
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) >= as.Date('2020-08-10'), 0, sf$InitialApprovalAmount)
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$cum_quant_avg <- rollapply(sf$cumu, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$tchange_avg <- rollapply(sf$tot_change, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$id <- 1
sf$signal <- ifelse(as.Date(sf$DateApproved) >= as.Date('2020-03-16') & as.Date(sf$DateApproved) <= as.Date('2020-03-21'), 1, 0)
sf$preppp <- ifelse(as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, 1)
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
cor(sf$InitialApprovalAmount, sf$Loan.amount, 'complete')
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(subset(sf, as.Date(DateApproved) >= as.Date('2020-03-26') &as.Date(DateApproved) <= as.Date('2020-08-10'))) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
n
n
r1 <- feols(log(Loan.amount) ~ log(l(InitialApprovalAmount)) , sf, panel.id = ~id + DateApproved, se='iid')
r3 <- feols(log(dw_quant_avg) ~ log(quant_week_avg), sf, panel.id = ~id + DateApproved, se='iid')
etable(r1,r3, dict= dict1,
drop = '(Intercept)',
se = 'white',
tex = F)
r1
r1 <- feols(log(Loan.amount) ~ log(InitialApprovalAmount) , sf, panel.id = ~id + DateApproved, se='iid')
r1
r1 <- feols(log(Loan.amount) ~ log(InitialApprovalAmount) , sf, panel.id = ~id + DateApproved, se='white')
r1
r3 <- feols(log(dw_quant_avg) ~ log(ppp_week_avg), sf, panel.id = ~id + DateApproved, se='iid')
etable(r1,r3, dict= dict1,
drop = '(Intercept)',
se = 'white',
tex = F)
#Regressions
dict1 <- c('log(InitialApprovalAmount)' = 'PPP', 'log(quant_week_avg)' = 'Avg Weekly PPP', 'log(Loan.amount)' = 'DW Quant',
'log(dw_quant_avg)' = 'Avg Weekly DW Quant')
etable(r1,r3, dict= dict1,
drop = '(Intercept)',
se = 'white',
tex = F)
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(InitialApprovalAmount), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(Loan.amount), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
# Import
ppb <- read_csv("D:/Research/DW lending empirical/Data/ppp_daily.csv")
dwborrow <- read_csv("D:/Research/DW lending empirical/Data/dwborrow.csv")
pplf <- read_csv("D:/Research/DW lending empirical/Data/ppplf_full.csv")
# Aggregate Data 1: Correlation between dw borrowing and aggregate ppp loans-------
# Transformation
ppb2<- aggregate(Original.Outstanding.Advance.Amount ~ Date.Of.Advance, pplf, sum)
sf <- full_join(ppb, ppb2, by=c('DateApproved' = 'Date.Of.Advance'))
sf <- sf[order(sf$DateApproved),]
sf[is.na(sf)] <- 0
sf$tot_change <- sf$Original.Outstanding.Advance.Amount - sf$InitialApprovalAmount
sf$cumu <- cumsum(sf[, 'tot_change'])
dwborrow1 <- dwborrow %>% count(Loan.date)
dwborrow2 <- aggregate(Loan.amount ~ Loan.date, dwborrow, FUN = sum)
dwborrow1 <- subset(full_join(dwborrow2,dwborrow1), as.Date(Loan.date) >= as.Date('2020-01-01'))
sf <- full_join(sf,dwborrow1, by=c('DateApproved' = 'Loan.date')) %>% select(-contains("..."))
sf <- subset(sf, as.Date(DateApproved) <= as.Date('2020-10-01'))
sf <- sf[order(sf$DateApproved),]
ind <- which(is.na(sf$n) == TRUE)
for (i in 2:length(ind)) {
if (ind[i] == ind[i-1]+1) {
ind <- ind[-i]
}
print(length(ind))
}
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
ind <- ind[1:length(ind)-1]
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
sf[ind-1,'InitialApprovalAmount'] <- sf[ind-1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
rm(ind, dwborrow1, dwborrow2)
sf$cumu <- sf$cumu$tot_change
sf$cumu_init <- 4075359310000 + sf$cumu
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, sf$InitialApprovalAmount)
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) >= as.Date('2020-08-10'), 0, sf$InitialApprovalAmount)
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$cum_quant_avg <- rollapply(sf$cumu, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$tchange_avg <- rollapply(sf$tot_change, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$id <- 1
sf$signal <- ifelse(as.Date(sf$DateApproved) >= as.Date('2020-03-16') & as.Date(sf$DateApproved) <= as.Date('2020-03-21'), 1, 0)
sf$preppp <- ifelse(as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, 1)
# Figures
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP')) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW')) +
scale_y_continuous(name = "Moving Avg of DW Loan", sec.axis = sec_axis(~.*3, name="Moving Avg of PPP Loan")) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(InitialApprovalAmount), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(Loan.amount), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(subset(sf, as.Date(DateApproved) >= as.Date('2020-03-26') &as.Date(DateApproved) <= as.Date('2020-08-10'))) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ggplot(subset(sf, as.Date(DateApproved) >= as.Date('2020-04-01') &as.Date(DateApproved) <= as.Date('2020-08-10'))) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg+1), colour ='PPP')) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg+1), colour ='DW')) +
labs(x="Date") + theme(legend.position = c(.9, .9))
ppb
pplf
# Import
ppb <- read_csv("D:/Research/DW lending empirical/Data/ppp_daily.csv")
ppb
pplf
pppm <- read_csv("D:/Research/DW lending empirical/Data/ppp_bankmatched.csv")
ppp,
pppm
pplf
# Aggregate Data 2: correlation between dw borrowing (binary) and uncovered ppp loans (ppp loans - ppplf advance) -------
full_join(pplf, pppm, by=c('rssd' = 'Institution.RSSD'))
# Aggregate Data 2: correlation between dw borrowing (binary) and uncovered ppp loans (ppp loans - ppplf advance) -------
full_join(pppm, pplf, by=c('rssd' = 'Institution.RSSD'))
# Aggregate Data 2: correlation between dw borrowing (binary) and uncovered ppp loans (ppp loans - ppplf advance) -------
full_join(pppm, pplf, by=c('rssd' = 'Institution.RSSD')) %>% select(-contains("..."))
# Aggregate Data 2: correlation between dw borrowing (binary) and uncovered ppp loans (ppp loans - ppplf advance) -------
sf <- full_join(pppm, pplf, by=c('rssd' = 'Institution.RSSD')) %>% select(-contains("..."))
View(sf)
pplf
pppm
left_join(sf,dwborrow, by=c('Institution.ABA' = 'Borrower.ABA.number'))
# Aggregate Data 2: correlation between dw borrowing (binary) and uncovered ppp loans (ppp loans - ppplf advance) -------
sf <- full_join(data.frame(pppm), data.frame(pplf), by=c('rssd' = 'Institution.RSSD')) %>% select(-contains("..."))
left_join(sf,dwborrow, by=c('Institution.ABA' = 'Borrower.ABA.number'))
sf <- left_join(sf,dwborrow, by=c('Institution.ABA' = 'Borrower.ABA.number'))
sf[!is.na(sf$Institution.ABA)]
sf[!is.na(sf$Institution.ABA).]
sf[!is.na(sf$Institution.ABA),]
View(pppm)
# Aggregate Data 2: correlation between dw borrowing (binary) and uncovered ppp loans (ppp loans - ppplf advance) -------
# Bank Level Data
sf <- full_join(data.frame(pppm), data.frame(pplf), by=c('rssd' = 'Institution.RSSD')) %>% select(-contains("..."))
sf
pppm
View(pppm)
View(pplf)
pplf
# Aggregate Data 2: correlation between dw borrowing (binary) and uncovered ppp loans (ppp loans - ppplf advance) -------
# Bank Level Data
aggregate(Original.Outstanding.Advance.Amount ~ Institution.RSSD + Date.Of.Advance, pplf, sum)
sf <- full_join(data.frame(pppm), data.frame(aggregate(Original.Outstanding.Advance.Amount ~ Institution.RSSD + Date.Of.Advance, pplf, sum)),
by=c('rssd' = 'Institution.RSSD')) %>% select(-contains("..."))
sf
# Aggregate Data 2: correlation between dw borrowing (binary) and uncovered ppp loans (ppp loans - ppplf advance) -------
# Bank Level Data
sf <- full_join(data.frame(pppm), data.frame(aggregate(Original.Outstanding.Advance.Amount ~ Institution.RSSD + Date.Of.Advance, pplf, sum)),
by=c('rssd' = 'Institution.RSSD', 'DateApproved' = 'Date.Of.Advance')) %>% select(-contains("..."))
sf
View(sf)
left_join(sf,dwborrow, by=c('Institution.ABA' = 'Borrower.ABA.number'))
pppm
pplf
unique(pplf[,c('Institution.RSSD','Institution.ABA')])
left_join(sf,unique(pplf[,c('Institution.RSSD','Institution.ABA')]))
left_join(sf,unique(pplf[,c('Institution.RSSD','Institution.ABA')]), by=c('rssd','Institution.RSSD'))
left_join(sf,unique(pplf[,c('Institution.RSSD','Institution.ABA')]), by=c('rssd'='Institution.RSSD'))
pppm
pplf
left_join(pppm,pplf[,c('Institution.RSSD','Institution.ABA')],by=c('rssd' = 'Institution.RSSD'))
left_join(pppm,unique(pplf[,c('Institution.RSSD','Institution.ABA')]),by=c('rssd' = 'Institution.RSSD'))
# Aggregate Data 2: correlation between dw borrowing (binary) and uncovered ppp loans (ppp loans - ppplf advance) -------
# Bank Level Data
sf <- left_join(pppm,unique(pplf[,c('Institution.RSSD','Institution.ABA')]),by=c('rssd' = 'Institution.RSSD'))
View(sf)
