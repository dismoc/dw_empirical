sf[is.na(sf)] <- 0
sf$tot_change <- sf$Original.Outstanding.Advance.Amount - sf$InitialApprovalAmount
sf$cumu <- cumsum(sf[, 'tot_change'])
dwborrow1 <- dwborrow %>% count(Loan.date)
dwborrow2 <- aggregate(Loan.amount ~ Loan.date, dwborrow, FUN = sum)
dwborrow1 <- subset(full_join(dwborrow2,dwborrow1), as.Date(Loan.date) >= as.Date('2020-01-01'))
sf <- full_join(sf,dwborrow1, by=c('DateApproved' = 'Loan.date')) %>% select(-contains("..."))
sf <- subset(sf, as.Date(DateApproved) <= as.Date('2020-10-01'))
sf <- sf[order(sf$DateApproved),]
ind <- which(is.na(sf$n) == TRUE)
for (i in 2:length(ind)) {
if (ind[i] == ind[i-1]+1) {
ind <- ind[-i]
}
print(length(ind))
}
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
ind <- ind[1:length(ind)-1]
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
sf[ind-1,'InitialApprovalAmount'] <- sf[ind-1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
rm(ind, dwborrow1, dwborrow2)
# Creation
sf$cumu <- sf$cumu$tot_change
sf$cumu_init <- 4075359310000 + sf$cumu
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, sf$InitialApprovalAmount)
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) >= as.Date('2020-08-10'), 0, sf$InitialApprovalAmount)
sf[!sf$InitialApprovalAmount < 1e6,]
sf <- sf[!sf$InitialApprovalAmount < 1e6,]
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$cum_quant_avg <- rollapply(sf$cumu, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$tchange_avg <- rollapply(sf$tot_change, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$id <- 1
sf$signal <- ifelse(as.Date(sf$DateApproved) >= as.Date('2020-03-16') & as.Date(sf$DateApproved) <= as.Date('2020-03-21'), 1, 0)
sf$preppp <- ifelse(as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, 1)
sf
View(sf)
# PPP and DW loan correlation not log with cut
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW'), size=1.5) +
scale_y_continuous(name = "Daily DW Loans",
sec.axis = sec_axis(~.*3, name="Daily PPP Loans", labels = label_number(suffix = "B", scale = 1e-9)),
labels = label_number(suffix = "B", scale = 1e-9)) +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(sf$Loan.amount,sf$InitialApprovalAmount,'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=10e9)
#Now with the log values
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(InitialApprovalAmount+1), colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = log(Loan.amount+1), colour ='DW'), size=1.5) +
scale_y_continuous(name = "Log Value") +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(log(sf$Loan.amount+1),log(sf$InitialApprovalAmount+1),'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=10)
# using moving averages
ggplot(sf) +
geom_line(aes(x = DateApproved, y = ppp_week_avg/5, colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW'), size=1.5) +
scale_y_continuous(name = "Mov. Avg. DW Loans",
sec.axis = sec_axis(~.*5, name="Mov. Avg. PPP Loans", labels = unit_format(unit = "B", scale = 1e-9)),
labels = unit_format(unit = "B", scale = 1e-9)) +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(sf$ppp_week_avg,sf$dw_quant_avg,'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=5e9)
#Now with the log values
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg), colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg), colour ='DW'), size=1.5) +
scale_y_continuous(name = "MA Log Value") +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(log(sf$ppp_week_avg+1),log(sf$dw_quant_avg+1),'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=22)
# PPP and DW loan correlation not log with cut
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW'), size=1.5) +
scale_y_continuous(name = "Daily DW Loans",
sec.axis = sec_axis(~.*3, name="Daily PPP Loans", labels = label_number(suffix = "B", scale = 1e-9)),
labels = label_number(suffix = "B", scale = 1e-9)) +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(sf$Loan.amount,sf$InitialApprovalAmount,'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=10e9)
sf
View(sf)
ppb2<- aggregate(Original.Outstanding.Advance.Amount ~ Date.Of.Advance, pplf, sum)
sf <- full_join(ppb, ppb2, by=c('DateApproved' = 'Date.Of.Advance'))
sf <- sf[order(sf$DateApproved),]
sf[is.na(sf)] <- 0
sf$tot_change <- sf$Original.Outstanding.Advance.Amount - sf$InitialApprovalAmount
sf$cumu <- cumsum(sf[, 'tot_change'])
dwborrow1 <- dwborrow %>% count(Loan.date)
dwborrow2 <- aggregate(Loan.amount ~ Loan.date, dwborrow, FUN = sum)
dwborrow1 <- subset(full_join(dwborrow2,dwborrow1), as.Date(Loan.date) >= as.Date('2020-01-01'))
sf <- full_join(sf,dwborrow1, by=c('DateApproved' = 'Loan.date')) %>% select(-contains("..."))
sf <- subset(sf, as.Date(DateApproved) <= as.Date('2020-10-01'))
sf <- sf[order(sf$DateApproved),]
ind <- which(is.na(sf$n) == TRUE)
for (i in 2:length(ind)) {
if (ind[i] == ind[i-1]+1) {
ind <- ind[-i]
}
print(length(ind))
}
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
ind <- ind[1:length(ind)-1]
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
sf[ind-1,'InitialApprovalAmount'] <- sf[ind-1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
rm(ind, dwborrow1, dwborrow2)
# Creation
sf$cumu <- sf$cumu$tot_change
sf$cumu_init <- 4075359310000 + sf$cumu
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, sf$InitialApprovalAmount)
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) >= as.Date('2020-08-10'), 0, sf$InitialApprovalAmount)
sf <- sf[!sf$InitialApprovalAmount < 1e5,]
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$cum_quant_avg <- rollapply(sf$cumu, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$tchange_avg <- rollapply(sf$tot_change, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$id <- 1
sf$signal <- ifelse(as.Date(sf$DateApproved) >= as.Date('2020-03-16') & as.Date(sf$DateApproved) <= as.Date('2020-03-21'), 1, 0)
sf$preppp <- ifelse(as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, 1)
sf
View(sf)
sf <- sf[!sf$InitialApprovalAmount < 1e6,]
ppb2<- aggregate(Original.Outstanding.Advance.Amount ~ Date.Of.Advance, pplf, sum)
sf <- full_join(ppb, ppb2, by=c('DateApproved' = 'Date.Of.Advance'))
sf <- sf[order(sf$DateApproved),]
sf[is.na(sf)] <- 0
sf$tot_change <- sf$Original.Outstanding.Advance.Amount - sf$InitialApprovalAmount
sf$cumu <- cumsum(sf[, 'tot_change'])
dwborrow1 <- dwborrow %>% count(Loan.date)
dwborrow2 <- aggregate(Loan.amount ~ Loan.date, dwborrow, FUN = sum)
dwborrow1 <- subset(full_join(dwborrow2,dwborrow1), as.Date(Loan.date) >= as.Date('2020-01-01'))
sf <- full_join(sf,dwborrow1, by=c('DateApproved' = 'Loan.date')) %>% select(-contains("..."))
sf <- subset(sf, as.Date(DateApproved) <= as.Date('2020-10-01'))
sf <- sf[order(sf$DateApproved),]
ind <- which(is.na(sf$n) == TRUE)
for (i in 2:length(ind)) {
if (ind[i] == ind[i-1]+1) {
ind <- ind[-i]
}
print(length(ind))
}
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
ind <- ind[1:length(ind)-1]
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
sf[ind-1,'InitialApprovalAmount'] <- sf[ind-1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
rm(ind, dwborrow1, dwborrow2)
# Creation
sf$cumu <- sf$cumu$tot_change
sf$cumu_init <- 4075359310000 + sf$cumu
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, sf$InitialApprovalAmount)
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) >= as.Date('2020-08-10'), 0, sf$InitialApprovalAmount)
sf <- sf[!sf$InitialApprovalAmount < 1e6,]
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$cum_quant_avg <- rollapply(sf$cumu, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$tchange_avg <- rollapply(sf$tot_change, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$id <- 1
sf$signal <- ifelse(as.Date(sf$DateApproved) >= as.Date('2020-03-16') & as.Date(sf$DateApproved) <= as.Date('2020-03-21'), 1, 0)
sf$preppp <- ifelse(as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, 1)
sf
# PPP and DW loan correlation not log with cut
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW'), size=1.5) +
scale_y_continuous(name = "Daily DW Loans",
sec.axis = sec_axis(~.*3, name="Daily PPP Loans", labels = label_number(suffix = "B", scale = 1e-9)),
labels = label_number(suffix = "B", scale = 1e-9)) +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(sf$Loan.amount,sf$InitialApprovalAmount,'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=10e9)
#Now with the log values
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(InitialApprovalAmount+1), colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = log(Loan.amount+1), colour ='DW'), size=1.5) +
scale_y_continuous(name = "Log Value") +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(log(sf$Loan.amount+1),log(sf$InitialApprovalAmount+1),'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=10)
# using moving averages
ggplot(sf) +
geom_line(aes(x = DateApproved, y = ppp_week_avg/5, colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW'), size=1.5) +
scale_y_continuous(name = "Mov. Avg. DW Loans",
sec.axis = sec_axis(~.*5, name="Mov. Avg. PPP Loans", labels = unit_format(unit = "B", scale = 1e-9)),
labels = unit_format(unit = "B", scale = 1e-9)) +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(sf$ppp_week_avg,sf$dw_quant_avg,'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=5e9)
# using moving averages
ggplot(sf) +
geom_line(aes(x = DateApproved, y = ppp_week_avg/5, colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW'), size=1.5) +
scale_y_continuous(name = "Mov. Avg. DW Loans",
sec.axis = sec_axis(~.*5, name="Mov. Avg. PPP Loans", labels = unit_format(unit = "B", scale = 1e-9)),
labels = unit_format(unit = "B", scale = 1e-9)) +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(sf$ppp_week_avg/5,sf$dw_quant_avg,'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=5e9)
#Now with the log values
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg), colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg), colour ='DW'), size=1.5) +
scale_y_continuous(name = "MA Log Value") +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(log(sf$ppp_week_avg+1),log(sf$dw_quant_avg+1),'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=22)
ppb2<- aggregate(Original.Outstanding.Advance.Amount ~ Date.Of.Advance, pplf, sum)
sf <- full_join(ppb, ppb2, by=c('DateApproved' = 'Date.Of.Advance'))
sf <- sf[order(sf$DateApproved),]
sf[is.na(sf)] <- 0
sf$tot_change <- sf$Original.Outstanding.Advance.Amount - sf$InitialApprovalAmount
sf$cumu <- cumsum(sf[, 'tot_change'])
dwborrow1 <- dwborrow %>% count(Loan.date)
dwborrow2 <- aggregate(Loan.amount ~ Loan.date, dwborrow, FUN = sum)
dwborrow1 <- subset(full_join(dwborrow2,dwborrow1), as.Date(Loan.date) >= as.Date('2020-01-01'))
sf <- full_join(sf,dwborrow1, by=c('DateApproved' = 'Loan.date')) %>% select(-contains("..."))
sf <- subset(sf, as.Date(DateApproved) <= as.Date('2020-10-01'))
sf <- sf[order(sf$DateApproved),]
ind <- which(is.na(sf$n) == TRUE)
for (i in 2:length(ind)) {
if (ind[i] == ind[i-1]+1) {
ind <- ind[-i]
}
print(length(ind))
}
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
ind <- ind[1:length(ind)-1]
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
sf[ind-1,'InitialApprovalAmount'] <- sf[ind-1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
sf
sf$cumu <- sf$cumu$tot_change
sf$cumu_init <- 4075359310000 + sf$cumu
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, sf$InitialApprovalAmount)
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) >= as.Date('2020-08-10'), 0, sf$InitialApprovalAmount)
sf <- sf[!sf$InitialApprovalAmount < 1e6,]
sf
ppb2<- aggregate(Original.Outstanding.Advance.Amount ~ Date.Of.Advance, pplf, sum)
sf <- full_join(ppb, ppb2, by=c('DateApproved' = 'Date.Of.Advance'))
sf <- sf[order(sf$DateApproved),]
sf[is.na(sf)] <- 0
sf$tot_change <- sf$Original.Outstanding.Advance.Amount - sf$InitialApprovalAmount
sf$cumu <- cumsum(sf[, 'tot_change'])
dwborrow1 <- dwborrow %>% count(Loan.date)
dwborrow2 <- aggregate(Loan.amount ~ Loan.date, dwborrow, FUN = sum)
dwborrow1 <- subset(full_join(dwborrow2,dwborrow1), as.Date(Loan.date) >= as.Date('2020-01-01'))
sf <- full_join(sf,dwborrow1, by=c('DateApproved' = 'Loan.date')) %>% select(-contains("..."))
sf <- subset(sf, as.Date(DateApproved) <= as.Date('2020-10-01'))
sf <- sf[order(sf$DateApproved),]
ind <- which(is.na(sf$n) == TRUE)
for (i in 2:length(ind)) {
if (ind[i] == ind[i-1]+1) {
ind <- ind[-i]
}
print(length(ind))
}
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
ind <- ind[1:length(ind)-1]
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
sf[ind-1,'InitialApprovalAmount'] <- sf[ind-1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
rm(ind, dwborrow1, dwborrow2)
# Creation
sf$cumu <- sf$cumu$tot_change
sf$cumu_init <- 4075359310000 + sf$cumu
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, sf$InitialApprovalAmount)
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) >= as.Date('2020-08-10'), 0, sf$InitialApprovalAmount)
sf
View(sf)
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$cum_quant_avg <- rollapply(sf$cumu, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$tchange_avg <- rollapply(sf$tot_change, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$id <- 1
sf$signal <- ifelse(as.Date(sf$DateApproved) >= as.Date('2020-03-16') & as.Date(sf$DateApproved) <= as.Date('2020-03-21'), 1, 0)
sf$preppp <- ifelse(as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, 1)
sf
View(sf)
sf[!75:80,]
#Uncut
sf <- sf[-c(75:80),]
View(sf)
ppb2<- aggregate(Original.Outstanding.Advance.Amount ~ Date.Of.Advance, pplf, sum)
sf <- full_join(ppb, ppb2, by=c('DateApproved' = 'Date.Of.Advance'))
sf <- sf[order(sf$DateApproved),]
sf[is.na(sf)] <- 0
sf$tot_change <- sf$Original.Outstanding.Advance.Amount - sf$InitialApprovalAmount
sf$cumu <- cumsum(sf[, 'tot_change'])
dwborrow1 <- dwborrow %>% count(Loan.date)
dwborrow2 <- aggregate(Loan.amount ~ Loan.date, dwborrow, FUN = sum)
dwborrow1 <- subset(full_join(dwborrow2,dwborrow1), as.Date(Loan.date) >= as.Date('2020-01-01'))
sf <- full_join(sf,dwborrow1, by=c('DateApproved' = 'Loan.date')) %>% select(-contains("..."))
sf <- subset(sf, as.Date(DateApproved) <= as.Date('2020-10-01'))
sf <- sf[order(sf$DateApproved),]
ind <- which(is.na(sf$n) == TRUE)
for (i in 2:length(ind)) {
if (ind[i] == ind[i-1]+1) {
ind <- ind[-i]
}
print(length(ind))
}
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
ind <- ind[1:length(ind)-1]
sf[ind+1,'InitialApprovalAmount'] <- sf[ind+1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
ind <- which(is.na(sf$n) == TRUE)
sf[ind-1,'InitialApprovalAmount'] <- sf[ind-1,'InitialApprovalAmount'] + sf[ind,'InitialApprovalAmount']
sf <- sf[-ind,]
rm(ind, dwborrow1, dwborrow2)
# Creation
sf$cumu <- sf$cumu$tot_change
sf$cumu_init <- 4075359310000 + sf$cumu
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, sf$InitialApprovalAmount)
sf$InitialApprovalAmount <- ifelse(is.na(sf$InitialApprovalAmount) == TRUE & as.Date(sf$DateApproved) >= as.Date('2020-08-10'), 0, sf$InitialApprovalAmount)
sf <- sf[-c(75:80),]; sf <- sf[-c(121:123),];  #uncut
sf$ppp_week_avg <- rollapply(sf$InitialApprovalAmount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$dw_quant_avg <- rollapply(sf$Loan.amount, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$cum_quant_avg <- rollapply(sf$cumu, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$tchange_avg <- rollapply(sf$tot_change, 5, mean, na.rm=TRUE, fill = NA, partial=3)
sf$id <- 1
sf$signal <- ifelse(as.Date(sf$DateApproved) >= as.Date('2020-03-16') & as.Date(sf$DateApproved) <= as.Date('2020-03-21'), 1, 0)
sf$preppp <- ifelse(as.Date(sf$DateApproved) <= as.Date('2020-04-02'), 0, 1)
View(sf)
# PPP and DW loan correlation not log with cut
ggplot(sf) +
geom_line(aes(x = DateApproved, y = InitialApprovalAmount/3, colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = Loan.amount, colour ='DW'), size=1.5) +
scale_y_continuous(name = "Daily DW Loans",
sec.axis = sec_axis(~.*3, name="Daily PPP Loans", labels = label_number(suffix = "B", scale = 1e-9)),
labels = label_number(suffix = "B", scale = 1e-9)) +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(sf$Loan.amount,sf$InitialApprovalAmount,'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=10e9)
#Now with the log values
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(InitialApprovalAmount+1), colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = log(Loan.amount+1), colour ='DW'), size=1.5) +
scale_y_continuous(name = "Log Value") +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(log(sf$Loan.amount+1),log(sf$InitialApprovalAmount+1),'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=10)
# using moving averages
ggplot(sf) +
geom_line(aes(x = DateApproved, y = ppp_week_avg/5, colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = dw_quant_avg, colour ='DW'), size=1.5) +
scale_y_continuous(name = "Mov. Avg. DW Loans",
sec.axis = sec_axis(~.*5, name="Mov. Avg. PPP Loans", labels = unit_format(unit = "B", scale = 1e-9)),
labels = unit_format(unit = "B", scale = 1e-9)) +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(sf$ppp_week_avg,sf$dw_quant_avg,'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=5e9)
#Now with the log values
ggplot(sf) +
geom_line(aes(x = DateApproved, y = log(ppp_week_avg), colour ='PPP'), size=1.5) +
geom_line(aes(x = DateApproved, y = log(dw_quant_avg), colour ='DW'), size=1.5) +
scale_y_continuous(name = "MA Log Value") +
labs(x="Date") +
theme(legend.position = c(.9, .9), legend.title=element_blank(), text = element_text(18)) +
annotate('text', label = paste0('Correlation = ',round(cor(log(sf$ppp_week_avg+1),log(sf$dw_quant_avg+1),'complete'),2)),
x=max(sf$DateApproved, na.rm=TRUE) - 21, y=22)
df$RCONA570
df$RCONA247 - df$RCONA570
df$RCONG091
df$RCONG091 + df$RCONG094 + df$RCONG097 + df$RCONG100
df$RCON2122
df$RCON2122-df$RCONA570
df %>% group_by(IDRSSD,Date)
group_by(df,IDRSSD,Date)
group_by(df,IDRSSD,Date)$RCON2122
lead(group_by(df,IDRSSD,Date)$RCON2122)
df %>% group_by(IDRSSD,Date) %>% mutate(loans_nquarter = lead(RCON2122))
df %>% group_by(IDRSSD,Date) %>% mutate(loans_nquarter = lead(RCON2122, order_by=Date))
class(df$RCON2122)
pdata.frame(df, c('IDRSSD','Date')) %>% mutate(t1loans = lead(RCON2122))
df2 <- pdata.frame(df)
lead(df2$RCON2122)
df2$RCON2122
lead(df2$RCON2122,1)
rm(df2)
df %>% group_by(IDRSSD)
df %>% group_by(IDRSSD) %>% arrange(Date)
df %>% group_by(IDRSSD) %>% arrange(Date) &>& mutate(t1loan = lead(RCON2122))
df %>% group_by(IDRSSD) %>% arrange(Date) %>% mutate(t1loan = lead(RCON2122))
rm(matchlb, att)
gc()
df %>% group_by(IDRSSD) %>% arrange(Date) %>% mutate(t1loan = lead(RCON2122))
df %>% group_by(IDRSSD) %>% arrange(Date) %>% mutate(t1loan = dplyr::lead(RCON2122))
df <- df %>% group_by(IDRSSD) %>% arrange(Date) %>% mutate(t1loan = dplyr::lead(RCON2122))
gc()
gc()
df <- df %>% group_by(IDRSSD) %>% arrange(Date) %>% mutate(t1loan = dplyr::lead(RCON2122))
df$t1loan
df$t1loan - df$RCON2122
df$t1loan - df$RCON2122 - df$RCONA570
df$t1loan - (df$RCON2122 - df$RCONA570)
max(df$t1loan - (df$RCON2122 - df$RCONA570),0)
iflese(df$t1loan - (df$RCON2122 - df$RCONA570)) < 0, 0, df$t1loan - (df$RCON2122 - df$RCONA570)))
ifelse(df$t1loan - (df$RCON2122 - df$RCONA570)) < 0, 0, df$t1loan - (df$RCON2122 - df$RCONA570)))
ifelse(df$t1loan - (df$RCON2122 - df$RCONA570) < 0, 0, df$t1loan - (df$RCON2122 - df$RCONA570))
df$new_loans <- ifelse(df$t1loan - (df$RCON2122 - df$RCONA570) < 0, 0, df$t1loan - (df$RCON2122 - df$RCONA570))
df$new_nppp_loans <- ifelse(is.na(df$RCONLG27) == TRUE, df$new_loans, df$new_loans - df$RCONLG27)
df$new_nppp_loans
df$new_loans - df$new_nppp_loans
table(df$new_loans - df$new_nppp_loans)
# Show the share of loans that are non-ppp and ppp since 2019
plot1 <- subset(df, as.Date(Date) >= as.Date('2019-01-01'))
plot1[is.na(plot1$RCONLG27) == TRUE,'RCONLG27'] <- 0
plot1 <- aggregate(cbind(new_loans,RCONLG27) ~ Date, plot1, sum)
plot1 <- plot1 %>% gather('Loan Type', val,-Date)
plot1$Date <- as.Date(plot1$Date)
plot1
plot1$`Loan Type` <- ifelse(plot1$`Loan Type` == 'RCONLG27', 'PPP Loans', 'Non-PPP Loans')
ggplot(plot1, aes(x=Date,y=val,fill=`Loan Type`)) + geom_area() +
scale_y_continuous(labels = unit_format(unit = "T", scale = 1e-9)) +
ylab('Quantity') + theme(legend.position = c(.2, .5)) +
scale_color_hue(labels = c("T999", "T888")) +
scale_x_date(breaks = date_breaks("3 months")) +
theme(text = element_text(size = 16))
plot1
# Show the share of loans that are non-ppp and ppp since 2019
plot1 <- subset(df, as.Date(Date) >= as.Date('2019-01-01'))
plot1[is.na(plot1$RCONLG27) == TRUE,'RCONLG27'] <- 0
plot1 <- aggregate(cbind(new_loans,RCONLG27) ~ Date, plot1, sum)
plot1
# Show the share of loans that are non-ppp and ppp since 2019
plot1 <- subset(df, as.Date(Date) >= as.Date('2019-01-01'))
plot1[is.na(plot1$RCONLG27) == TRUE,'RCONLG27'] <- 0
plot1 <- aggregate(cbind(RCON2122, new_loans,RCONLG27) ~ Date, plot1, sum)
plot1
df$RCONA567 - df$RCONA570
df$RCONA247 - df$RCONA570
df$RCONA247 - df$RCONA571
df$RCONA570 - (df$RCONA247 - df$RCONA571)
max(df$RCONA570,(df$RCONA247 - df$RCONA571))
pmax(df$RCONA570,(df$RCONA247 - df$RCONA571))
df$new_loans <- ifelse(df$t1loan - (df$RCON2122 - pmax(df$RCONA570,(df$RCONA247 - df$RCONA571))) < 0, 0, df$t1loan - (df$RCON2122 - pmax(df$RCONA570,(df$RCONA247 - df$RCONA571))))
df$new_loans
plot1 <- subset(df, as.Date(Date) >= as.Date('2019-01-01'))
plot1[is.na(plot1$RCONLG27) == TRUE,'RCONLG27'] <- 0
plot1 <- aggregate(cbind(new_loans,RCONLG27) ~ Date, plot1, sum)
plot1 <- plot1 %>% gather('Loan Type', val,-Date)
plot1$Date <- as.Date(plot1$Date)
plot1$`Loan Type` <- ifelse(plot1$`Loan Type` == 'RCONLG27', 'PPP Loans', 'Non-PPP Loans')
ggplot(plot1, aes(x=Date,y=val,fill=`Loan Type`)) + geom_area() +
scale_y_continuous(labels = unit_format(unit = "T", scale = 1e-9)) +
ylab('Quantity') + theme(legend.position = c(.2, .5)) +
scale_color_hue(labels = c("T999", "T888")) +
scale_x_date(breaks = date_breaks("3 months")) +
theme(text = element_text(size = 16))
# Libraries ----
library(tidyverse)
library(mlr3verse)
library(plm)
library(pglm)
library(readxl)
library(dplyr)
library('DataCombine')
library('stargazer')
library('simpleboot')
library('Rpdb')
library('data.table')
library(ggplot2)
library('zoo')
library('fixest')
library('timeDate')
library('DescTools')
library('summarytools')
library(gtools)
library('fuzzyjoin')
library('lubridate')
library('xtable')
