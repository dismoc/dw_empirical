temp <- temp[order(temp)]
nf <- data.frame(IDRSSD = rep(unique(base$RSSDID), length(b2$DateApproved)), Date = temp) %>% arrange(IDRSSD, Date)
nf2 <- nf
nf <- nf[order(nf$IDRSSD,nf$Date),]; nf2 <- nf2[order(nf2$IDRSSD,nf2$Date),]
nf <- left_join(nf, b2, by=c('Date'='DateApproved')); nf2 <- left_join(nf2, base, by=c('IDRSSD' = 'RSSDID'))
nf2 <- subset(nf2, year(Date) == YEAR)
nf <- nf[(paste0(nf$IDRSSD,nf$Date) %in% paste0(nf2$IDRSSD,nf2$Date)),]
base
base <- aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDID, sod, FUN = sum)
base <- subset(base, RSSDID > 0)
base <- base %>% group_by(STALPBR) %>% mutate(total_state_dep =  sum(DEPSUMBR))
base$s_expo <- base$DEPSUMBR/base$total_state_dep
base
base <- reshape(data.frame(base[base$YEAR == 2019,c('STALPBR','RSSDID','s_expo')]), v.names = 's_expo', idvar = "RSSDID", timevar = "STALPBR", direction = "wide"); base$YEAR <- 2020
colnames(base) <- sub('s_expo.',"",colnames(base))
b2 <- data.frame(OriginatingLenderState = rep(unique(dfp$OriginatingLenderState),148) , DateApproved = rep(full_seq(c(as.Date('2020-03-31'),as.Date('2020-08-25')), period=1))) %>%
arrange(OriginatingLenderState, DateApproved)
temp <- data.frame(dfp)
temp$DateApproved <- as.Date(temp$DateApproved, '%m/%d/%Y')
b2 <- left_join(b2,aggregate(InitialApprovalAmount ~ DateApproved + OriginatingLenderState,temp, sum))
b2$InitialApprovalAmount <- log(b2$InitialApprovalAmount)
b2 <- reshape(b2, idvar = "DateApproved", timevar = "OriginatingLenderState", direction = "wide")
colnames(b2) <- sub('InitialApprovalAmount.',"",colnames(b2))
b2$YEAR <- year(b2$DateApproved)
temp <- rep(b2$DateApproved, length(unique(base$RSSDID)))
temp <- temp[order(temp)]
nf <- data.frame(IDRSSD = rep(unique(base$RSSDID), length(b2$DateApproved)), Date = temp) %>% arrange(IDRSSD, Date)
nf2 <- nf
nf <- nf[order(nf$IDRSSD,nf$Date),]; nf2 <- nf2[order(nf2$IDRSSD,nf2$Date),]
nf <- left_join(nf, b2, by=c('Date'='DateApproved')); nf2 <- left_join(nf2, base, by=c('IDRSSD' = 'RSSDID'))
nf2 <- subset(nf2, year(Date) == YEAR)
nf <- nf[(paste0(nf$IDRSSD,nf$Date) %in% paste0(nf2$IDRSSD,nf2$Date)),]
nf
nf2
mapply("*", nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))],
nf2[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))])
nf1 <- data.frame(nf[1:2] ,mapply("*", nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))],
nf2[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))]))
nf1
nf1$BInstr <- rowSums(nf1[,3:ncol(nf1)], na.rm=TRUE)
nf1 <- nf1[,c('IDRSSD','Date','BInstr')]
nf1
summary(nf1)
nf1 <- left_join(nf1, unique(sod[,c('RSSDID','CERT')]), by=c('IDRSSD' = 'RSSDID'))
nf1 <- nf1[!duplicated(nf1[c("IDRSSD", "Date")]),]
write.csv(nf1,"D:\\Research\\DW lending empirical\\Data\\binstr.csv")
rm(base,b2,nf,nf2,nf1)
ls <- subset(df, Date == '2020-03-31')
ls <- unique(data.frame(RSSD = ls$IDRSSD, ABA = ls$Primary.ABA.Routing.Number, STATE = ls$Financial.Institution.State))
sf2 <- data.frame(ls, Date=rep(full_seq(c(as.Date('2020-04-03'),as.Date('2020-08-08')), period=1),5165))
sf2 <- sf2 %>% group_by(RSSD) %>% mutate(Date = full_seq(c(as.Date('2020-04-03'),as.Date('2020-08-08')), period=1))
ls <- unique(smartbind(ls,data.frame(att)))
sf2 <- left_join(sf2,aggregate(InitialApprovalAmount ~ rssd + DateApproved, pppm, sum), by=c('RSSD'='rssd','Date'='DateApproved'))
sf2$InitialApprovalAmount <- ifelse(is.na(sf2$InitialApprovalAmount) == TRUE, 0, sf2$InitialApprovalAmount)
sf2 <- full_join(sf2,
left_join(data.frame(aggregate(Original.Outstanding.Advance.Amount ~ Institution.RSSD + Date.Of.Advance, pplf, sum)),
pplf[,c('Institution.RSSD', 'Date.Of.Advance', 'origin_date')]),
by=c('RSSD' = 'Institution.RSSD', 'Date' = 'Date.Of.Advance'))
#changing terms to overnights
dwborrow1 <- subset(dwborrow, Loan.date >= as.Date('2020-03-01') & Type.of.credit == 'Primary Credit')
dwborrow1$Borrower.ABA.number <- as.numeric(dwborrow1$Borrower.ABA.number)
dwborrow1 <- dwborrow1[rep(1:nrow(dwborrow1), times=dwborrow1$Term), ]
for (i in 2:nrow(dwborrow1)){
if (dwborrow1[i,'Term'] > 1 & dwborrow1[i,'Borrower.ABA.number'] == dwborrow1[i-1,'Borrower.ABA.number']) {
dwborrow1[i,'Loan.date'] <- dwborrow1[i-1,'Loan.date']+1
}
}
sf2 <- full_join(sf2,dwborrow1[,c('Loan.date','Borrower.ABA.number','Loan.amount','Borrower.state','Term')], by=c('ABA' = 'Borrower.ABA.number', 'Date' = 'Loan.date'))
sf2[is.na(sf2$Original.Outstanding.Advance.Amount),c('Original.Outstanding.Advance.Amount')] <- 0
sf2[is.na(sf2$Loan.amount),c('Loan.amount')] <- 0
keep <- c('Date','size','IDRSSD','reserve_asset_ratio','reserve_loan_ratio','RCON2170','RCON0071','RCON0081','RCON2200','eqcaprat','age','borr_total','FED','exposure','OFFICES', 'aq', 'roe','RCONB529',
'RCFA7204')
temp <- subset(df, as.Date(Date) >= as.Date('2020-03-31'))[,keep]
temp$Date <- as.Date(temp$Date)
sf2$Quarter <- as.Date(quarter(sf2$Date, type='date_first')-1)
sf2 <- left_join(sf2, temp, by=c('RSSD' = 'IDRSSD', 'Quarter' = 'Date'))
setnames(sf2, old=c('InitialApprovalAmount','Original.Outstanding.Advance.Amount', 'Loan.amount'),
new = c('PPP','PPPLF','DW'))
sf2$Reserves <- (sf2$RCON0081 + sf2$RCON0071)*1000
sf2$dwsores <- sf2$DW*100/sf2$RCON2170
sf2$cs_ppp <- sf2$cs_ppp/sf2$RCON2170
sf2$ppp_so_reserves <- sf2$PPP*100/sf2$RCON2170
sf2$ppp_so_reserves <- ifelse(is.na(sf2$ppp_so_reserves) == TRUE, 0, sf2$ppp_so_reserves)
sf2$lfsores <- sf2$PPPLF/sf2$RCON2170
sf2$delt_so_reserves <- sf2$r_delt*100/sf2$RCON2170
sf2$dwbin_notest <- ifelse(sf2$dwsores > 1, 1,0)
sf2$dwbin_notest <- ifelse(is.na(sf2$dwbin_notest) == TRUE, 0, sf2$dwbin_notest)
sf2$dwsores <- ifelse(sf2$dwbin_notest == 1, sf2$dwsores, 0)
sf2$dw_bin <- ifelse(sf2$DW > 0, 1, 0)
sf2$levratio <- sf2$RCFA7204
sf2$bigsmall <- ifelse(sf2$RCON2170 > 1305000, 1, 0)
sf2$PPPLF_ind <- ifelse(sf2$PPPLF > 0, 1, 0)
sf2$r_delt <- -sf2$PPPLF + sf2$PPP
sf2 <- sf2[order(sf2$RSSD,sf2$Date),]
sf2 <- sf2 %>% group_by(RSSD) %>% mutate(cs_ppp = cumsum(PPP), cs_delt = cumsum(r_delt))
sf2$month <- month(sf2$Date)
sf2$rsa <- sf2$Reserves/sf2$RCON2170
sf2$lsa <- sf2$RCONB529/sf2$RCON2170
sf2$dsa <- sf2$RCON2200/sf2$RCON2170
temp <- aggregate(cbind(size,reserve_asset_ratio) ~ RSSD, sf2, mean) %>% mutate(size_quint = ntile(size,4), shock_quint = ntile(reserve_asset_ratio,5))
sf2 <- left_join(sf2, temp[,c('RSSD','size_quint','shock_quint')], by = 'RSSD')
temp <-aggregate(cbind(PPP,DW,PPPLF) ~ RSSD, sf2, sum)
temp$PPPLF_i <- ifelse(temp$PPPLF > 0, 1, 0)
temp$DW_i <- ifelse(temp$DW > 0, 1, 0)
temp$PPP_i <- ifelse(temp$PPP > 0, 1, 0)
sf2 <- left_join(sf2,temp[,c('RSSD','PPPLF_i','DW_i','PPP_i')])
sf2$State <- coalesce(sf2$STATE, sf2$Borrower.state)
#Create series on whether bank has accessed the LF within the past month
t <- aggregate(cbind(PPPLF_ind,PPPLF) ~ RSSD + Date, sf2, sum) %>% group_by(RSSD) %>% arrange(RSSD, Date)
t <- t %>% group_by(RSSD) %>%
mutate(LF_30i = rollapplyr(PPPLF_ind, width = 30, FUN = sum, partial = TRUE),
LF_30 = rollapplyr(PPPLF, width = 30, FUN = sum, partial = TRUE)) %>%
drop_na()
t$LF_30i <- ifelse(t$LF_30 > 0, 1, 0)
sf2 <- left_join(sf2,t[,c('RSSD','Date','LF_30')],by=c('RSSD','Date'))
sf2$LF_30 <- sf2$LF_30/sf2$Reserves
sf2$LF_30 <- ifelse(is.na(sf2$LF_30) == TRUE, 0, sf2$LF_30)
sf2 <- left_join(sf2,binstr,by=c('RSSD'='IDRSSD','Date'))
# create series on whether bank has used DW 5 years pre-covid
dwborrow1 <- subset(dwborrow, Loan.date >= '2015-04-03' & Loan.date < '2020-04-03')
ls <- intersect(unique(sf2$ABA),unique(dwborrow1$Borrower.ABA.number))
sf2[sf2$ABA %in% ls, 'precovdw'] <- 1
sf2$precovdw <- ifelse(is.na(sf2$precovdw) == TRUE, 0, 1)
# Regressions
sf3 <- subset(sf2, Date >= as.Date('2020-04-03') & Date <= as.Date('2020-08-08'))
sf3 <- sf3[!duplicated(sf3[c("RSSD", "Date")]),]
sf3 <- sf3 %>% drop_na(RSSD, Date, State, size_quint)
sf3 <- sf3[!sf3$Reserves ==0,]
#sf3 <- sf3[!sf3$delt_so_reserves <= 0,]
sf3 <- sf3[rowSums(is.na(sf3)) != ncol(sf3), ]
#stargazer(data.frame(sf3[,c('PPP','PPPLF','PPPLF_i','DW','DW_i','reserve_asset_ratio','OFFICES','eqcaprat','precovdw')])) #summary statistic
dict1 <- c('dw_bin' = 'DW Prob', 'demand_so_reserves' = 'Demand Shock', 'reserve_asset_ratio' = 'RA Ratio',
'size' = 'Size', 'log(PPPLF+1)' = 'Log(PPPLF)', 'log(RCON0010)' = 'Log(Reserves)',
'eqcaprat' = 'Equity Cap Ratio', 'ppp_so_reserves' = 'Demand Shock',
'ppp_so_reserves x PPPLF_ind' = 'DS*PPPLF_ind', 'log(borr_total+1)' = 'Log(FF Borrowing)',
'log(ppp_so_reserves)' = 'Log(Demand Shock)', 'log(PPP)' = 'Log(PPP)',
'dwbin_notest' = 'DW Prob', 'log(reserve_asset_ratio)' = 'Log RA Ratio',
'LF_30' = 'LF_{30}', 'log(eqcaprat)' = 'Log Equity Cap Ratio')
binstr <- read_csv("D:/Research/DW lending empirical/Data/binstr.csv")
ls <- subset(df, Date == '2020-03-31')
ls <- unique(data.frame(RSSD = ls$IDRSSD, ABA = ls$Primary.ABA.Routing.Number, STATE = ls$Financial.Institution.State))
sf2 <- data.frame(ls, Date=rep(full_seq(c(as.Date('2020-04-03'),as.Date('2020-08-08')), period=1),5165))
sf2 <- sf2 %>% group_by(RSSD) %>% mutate(Date = full_seq(c(as.Date('2020-04-03'),as.Date('2020-08-08')), period=1))
ls <- unique(smartbind(ls,data.frame(att)))
sf2 <- left_join(sf2,aggregate(InitialApprovalAmount ~ rssd + DateApproved, pppm, sum), by=c('RSSD'='rssd','Date'='DateApproved'))
sf2$InitialApprovalAmount <- ifelse(is.na(sf2$InitialApprovalAmount) == TRUE, 0, sf2$InitialApprovalAmount)
sf2 <- full_join(sf2,
left_join(data.frame(aggregate(Original.Outstanding.Advance.Amount ~ Institution.RSSD + Date.Of.Advance, pplf, sum)),
pplf[,c('Institution.RSSD', 'Date.Of.Advance', 'origin_date')]),
by=c('RSSD' = 'Institution.RSSD', 'Date' = 'Date.Of.Advance'))
#changing terms to overnights
dwborrow1 <- subset(dwborrow, Loan.date >= as.Date('2020-03-01') & Type.of.credit == 'Primary Credit')
dwborrow1$Borrower.ABA.number <- as.numeric(dwborrow1$Borrower.ABA.number)
dwborrow1 <- dwborrow1[rep(1:nrow(dwborrow1), times=dwborrow1$Term), ]
for (i in 2:nrow(dwborrow1)){
if (dwborrow1[i,'Term'] > 1 & dwborrow1[i,'Borrower.ABA.number'] == dwborrow1[i-1,'Borrower.ABA.number']) {
dwborrow1[i,'Loan.date'] <- dwborrow1[i-1,'Loan.date']+1
}
}
sf2 <- full_join(sf2,dwborrow1[,c('Loan.date','Borrower.ABA.number','Loan.amount','Borrower.state','Term')], by=c('ABA' = 'Borrower.ABA.number', 'Date' = 'Loan.date'))
sf2[is.na(sf2$Original.Outstanding.Advance.Amount),c('Original.Outstanding.Advance.Amount')] <- 0
sf2[is.na(sf2$Loan.amount),c('Loan.amount')] <- 0
keep <- c('Date','size','IDRSSD','reserve_asset_ratio','reserve_loan_ratio','RCON2170','RCON0071','RCON0081','RCON2200','eqcaprat','age','borr_total','FED','exposure','OFFICES', 'aq', 'roe','RCONB529',
'RCFA7204')
temp <- subset(df, as.Date(Date) >= as.Date('2020-03-31'))[,keep]
temp$Date <- as.Date(temp$Date)
sf2$Quarter <- as.Date(quarter(sf2$Date, type='date_first')-1)
sf2 <- left_join(sf2, temp, by=c('RSSD' = 'IDRSSD', 'Quarter' = 'Date'))
setnames(sf2, old=c('InitialApprovalAmount','Original.Outstanding.Advance.Amount', 'Loan.amount'),
new = c('PPP','PPPLF','DW'))
sf2$Reserves <- (sf2$RCON0081 + sf2$RCON0071)*1000
sf2$dwsores <- sf2$DW*100/sf2$RCON2170
sf2$cs_ppp <- sf2$cs_ppp/sf2$RCON2170
sf2$ppp_so_reserves <- sf2$PPP*100/sf2$RCON2170
sf2$ppp_so_reserves <- ifelse(is.na(sf2$ppp_so_reserves) == TRUE, 0, sf2$ppp_so_reserves)
sf2$lfsores <- sf2$PPPLF/sf2$RCON2170
sf2$delt_so_reserves <- sf2$r_delt*100/sf2$RCON2170
sf2$RCON2170
sf2$PPPLF
sf2$dwbin_notest <- ifelse(sf2$dwsores > 1, 1,0)
sf2$dwbin_notest <- ifelse(is.na(sf2$dwbin_notest) == TRUE, 0, sf2$dwbin_notest)
sf2$dwsores <- ifelse(sf2$dwbin_notest == 1, sf2$dwsores, 0)
sf2$dw_bin <- ifelse(sf2$DW > 0, 1, 0)
sf2$levratio <- sf2$RCFA7204
sf2$bigsmall <- ifelse(sf2$RCON2170 > 1305000, 1, 0)
sf2$PPPLF_ind <- ifelse(sf2$PPPLF > 0, 1, 0)
sf2$r_delt <- -sf2$PPPLF + sf2$PPP
sf2 <- sf2[order(sf2$RSSD,sf2$Date),]
sf2 <- sf2 %>% group_by(RSSD) %>% mutate(cs_ppp = cumsum(PPP), cs_delt = cumsum(r_delt))
sf2$month <- month(sf2$Date)
sf2$rsa <- sf2$Reserves/sf2$RCON2170
sf2$lsa <- sf2$RCONB529/sf2$RCON2170
sf2$dsa <- sf2$RCON2200/sf2$RCON2170
temp <- aggregate(cbind(size,reserve_asset_ratio) ~ RSSD, sf2, mean) %>% mutate(size_quint = ntile(size,4), shock_quint = ntile(reserve_asset_ratio,5))
sf2 <- left_join(sf2, temp[,c('RSSD','size_quint','shock_quint')], by = 'RSSD')
temp <-aggregate(cbind(PPP,DW,PPPLF) ~ RSSD, sf2, sum)
temp$PPPLF_i <- ifelse(temp$PPPLF > 0, 1, 0)
temp$DW_i <- ifelse(temp$DW > 0, 1, 0)
temp$PPP_i <- ifelse(temp$PPP > 0, 1, 0)
sf2 <- left_join(sf2,temp[,c('RSSD','PPPLF_i','DW_i','PPP_i')])
sf2$State <- coalesce(sf2$STATE, sf2$Borrower.state)
#Create series on whether bank has accessed the LF within the past month
t <- aggregate(cbind(PPPLF_ind,PPPLF) ~ RSSD + Date, sf2, sum) %>% group_by(RSSD) %>% arrange(RSSD, Date)
t <- t %>% group_by(RSSD) %>%
mutate(LF_30i = rollapplyr(PPPLF_ind, width = 30, FUN = sum, partial = TRUE),
LF_30 = rollapplyr(PPPLF, width = 30, FUN = sum, partial = TRUE)) %>%
drop_na()
t$LF_30i <- ifelse(t$LF_30 > 0, 1, 0)
sf2 <- left_join(sf2,t[,c('RSSD','Date','LF_30')],by=c('RSSD','Date'))
sf2$LF_30 <- sf2$LF_30/sf2$Reserves
sf2$LF_30 <- ifelse(is.na(sf2$LF_30) == TRUE, 0, sf2$LF_30)
sf2 <- left_join(sf2,binstr,by=c('RSSD'='IDRSSD','Date'))
# create series on whether bank has used DW 5 years pre-covid
dwborrow1 <- subset(dwborrow, Loan.date >= '2015-04-03' & Loan.date < '2020-04-03')
ls <- intersect(unique(sf2$ABA),unique(dwborrow1$Borrower.ABA.number))
sf2[sf2$ABA %in% ls, 'precovdw'] <- 1
sf2$precovdw <- ifelse(is.na(sf2$precovdw) == TRUE, 0, 1)
# Regressions
sf3 <- subset(sf2, Date >= as.Date('2020-04-03') & Date <= as.Date('2020-08-08'))
sf3 <- sf3[!duplicated(sf3[c("RSSD", "Date")]),]
sf3 <- sf3 %>% drop_na(RSSD, Date, State, size_quint)
sf3 <- sf3[!sf3$Reserves ==0,]
#sf3 <- sf3[!sf3$delt_so_reserves <= 0,]
sf3 <- sf3[rowSums(is.na(sf3)) != ncol(sf3), ]
#Table 2: Linear model
t1 <- list()
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + reserve_asset_ratio + size + eqcaprat + rsa + lsa + dsa| RSSD + Date^State  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[1]] <- feols(dwbin_notest ~log(ppp_so_reserves+1)  + log(LF_30+1) + reserve_asset_ratio + size + eqcaprat + rsa + lsa + dsa| RSSD + Date^State  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[3]] <- update(t1[[2]], . ~. - log(ppp_so_reserves+1) |.| log(ppp_so_reserves+1) ~ BInstr )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + reserve_asset_ratio + size + eqcaprat + rsa + lsa + dsa| RSSD + Date^State  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[3]]
#Robustness - Fixed Effects
t6 <- list()
t6[[1]] <- update(t1[[length(t1)]], .~. |. - RSSD - Date)
t6[[2]] <- update(t1[[length(t1)]], .~. |. - RSSD)
t6[[3]] <- update(t1[[length(t1)]], .~. |. - RSSD + FED)
t6[[4]] <- update(t1[[length(t1)]], .~. |. - RSSD + month^State)
t6[[5]] <- update(t1[[length(t1)]], .~. |. - Date + Date^State)
etable(t1[[length(t1)]], t6, dict=dict1, se='cluster', tex=F, cluster= 'RSSD',
drop = c('Intercept','Size', 'eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','precovdw','age','OFFICES'))
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + reserve_asset_ratio + size + eqcaprat + rsa + lsa + dsa| RSSD + Date  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
#Robustness - Fixed Effects
t6 <- list()
t6[[1]] <- update(t1[[length(t1)]], .~. |. - RSSD - Date)
t6[[2]] <- update(t1[[length(t1)]], .~. |. - RSSD)
t6[[3]] <- update(t1[[length(t1)]], .~. |. - RSSD + FED)
t6[[4]] <- update(t1[[length(t1)]], .~. |. - RSSD + month^State)
t6[[5]] <- update(t1[[length(t1)]], .~. |. - Date + Date^State)
etable(t1[[length(t1)]], t6, dict=dict1, se='cluster', tex=F, cluster= 'RSSD',
drop = c('Intercept','Size', 'eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','precovdw','age','OFFICES'))
# clustering
t3 <- list()
t3[[1]] <- update(t1[[2]], se = 'white')
t3[[2]] <- update(t3[[1]], se = 'cluster', cluster = c('RSSD','Date'))
t3[[3]] <- update(t3[[1]], se = 'cluster', cluster = c('RSSD','month'))
t3[[4]] <- update(t3[[1]], se = 'cluster', cluster = 'FED')
t3[[5]] <- update(t3[[1]], se = 'cluster', cluster = 'State')
etable(t3, dict=dict1, tex=F,
drop = c('eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','Size','exposure'))
t3[[1]] <- update(t1[[3]], se = 'white')
t3[[2]] <- update(t3[[1]], se = 'cluster', cluster = c('RSSD','Date'))
t3[[3]] <- update(t3[[1]], se = 'cluster', cluster = c('RSSD','month'))
t3[[4]] <- update(t3[[1]], se = 'cluster', cluster = 'FED')
t3[[5]] <- update(t3[[1]], se = 'cluster', cluster = 'State')
etable(t3, dict=dict1, tex=F,
drop = c('eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','Size','exposure'))
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + reserve_asset_ratio + size + eqcaprat + rsa + lsa + dsa| RSSD^month + Date  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + reserve_asset_ratio + size + eqcaprat + rsa + lsa + dsa| RSSD + Date  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + log(reserve_asset_ratio) + size + eqcaprat + rsa + lsa + dsa| RSSD + Date  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + log(reserve_asset_ratio) + size + log(eqcaprat) + rsa + lsa + dsa| RSSD + Date  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[3]]
etable(t1[[3]],stage=1)
pppm <- read_csv("D:/Research/DW lending empirical/Data/ppp_bankmatched.csv")
sod <- data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/ALL_2019.csv"),show_col_types = FALSE))
dfp <- read_delim(paste0("D:/Research/DW lending empirical/Data/ppp_sba/",list[1]), show_col_types = FALSE)
base <- aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDID, sod, FUN = sum)
base <- subset(base, RSSDID > 0)
base <- base %>% group_by(STALPBR) %>% mutate(total_state_dep =  sum(DEPSUMBR))
base$s_expo <- base$DEPSUMBR/base$total_state_dep
base <- reshape(data.frame(base[base$YEAR == 2019,c('STALPBR','RSSDID','s_expo')]), v.names = 's_expo', idvar = "RSSDID", timevar = "STALPBR", direction = "wide"); base$YEAR <- 2020
colnames(base) <- sub('s_expo.',"",colnames(base))
b2 <- data.frame(OriginatingLenderState = rep(unique(dfp$OriginatingLenderState),148) , DateApproved = rep(full_seq(c(as.Date('2020-03-31'),as.Date('2020-08-25')), period=1))) %>%
arrange(OriginatingLenderState, DateApproved)
temp <- data.frame(dfp)
temp$DateApproved <- as.Date(temp$DateApproved, '%m/%d/%Y')
b2 <- left_join(b2,aggregate(InitialApprovalAmount ~ DateApproved + OriginatingLenderState,temp, sum))
b2$InitialApprovalAmount <- b2$InitialApprovalAmount
b2 <- reshape(b2, idvar = "DateApproved", timevar = "OriginatingLenderState", direction = "wide")
colnames(b2) <- sub('InitialApprovalAmount.',"",colnames(b2))
b2$YEAR <- year(b2$DateApproved)
temp <- rep(b2$DateApproved, length(unique(base$RSSDID)))
temp <- temp[order(temp)]
nf <- data.frame(IDRSSD = rep(unique(base$RSSDID), length(b2$DateApproved)), Date = temp) %>% arrange(IDRSSD, Date)
nf2 <- nf
nf <- nf[order(nf$IDRSSD,nf$Date),]; nf2 <- nf2[order(nf2$IDRSSD,nf2$Date),]
nf <- left_join(nf, b2, by=c('Date'='DateApproved')); nf2 <- left_join(nf2, base, by=c('IDRSSD' = 'RSSDID'))
nf2 <- subset(nf2, year(Date) == YEAR)
nf <- nf[(paste0(nf$IDRSSD,nf$Date) %in% paste0(nf2$IDRSSD,nf2$Date)),]
nf1 <- data.frame(nf[1:2] ,mapply("*", nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))],
nf2[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))]))
nf1$BInstr <- rowSums(nf1[,3:ncol(nf1)], na.rm=TRUE)
nf1 <- nf1[,c('IDRSSD','Date','BInstr')]
nf1 <- left_join(nf1, unique(sod[,c('RSSDID','CERT')]), by=c('IDRSSD' = 'RSSDID'))
nf1 <- nf1[!duplicated(nf1[c("IDRSSD", "Date")]),]
binstr <- nf1
# Bank Level Data: -----
ls <- subset(df, Date == '2020-03-31')
ls <- unique(data.frame(RSSD = ls$IDRSSD, ABA = ls$Primary.ABA.Routing.Number, STATE = ls$Financial.Institution.State))
sf2 <- data.frame(ls, Date=rep(full_seq(c(as.Date('2020-04-03'),as.Date('2020-08-08')), period=1),5165))
sf2 <- sf2 %>% group_by(RSSD) %>% mutate(Date = full_seq(c(as.Date('2020-04-03'),as.Date('2020-08-08')), period=1))
ls <- unique(smartbind(ls,data.frame(att)))
sf2 <- left_join(sf2,aggregate(InitialApprovalAmount ~ rssd + DateApproved, pppm, sum), by=c('RSSD'='rssd','Date'='DateApproved'))
sf2$InitialApprovalAmount <- ifelse(is.na(sf2$InitialApprovalAmount) == TRUE, 0, sf2$InitialApprovalAmount)
sf2 <- full_join(sf2,
left_join(data.frame(aggregate(Original.Outstanding.Advance.Amount ~ Institution.RSSD + Date.Of.Advance, pplf, sum)),
pplf[,c('Institution.RSSD', 'Date.Of.Advance', 'origin_date')]),
by=c('RSSD' = 'Institution.RSSD', 'Date' = 'Date.Of.Advance'))
#changing terms to overnights
dwborrow1 <- subset(dwborrow, Loan.date >= as.Date('2020-03-01') & Type.of.credit == 'Primary Credit')
dwborrow1$Borrower.ABA.number <- as.numeric(dwborrow1$Borrower.ABA.number)
dwborrow1 <- dwborrow1[rep(1:nrow(dwborrow1), times=dwborrow1$Term), ]
for (i in 2:nrow(dwborrow1)){
if (dwborrow1[i,'Term'] > 1 & dwborrow1[i,'Borrower.ABA.number'] == dwborrow1[i-1,'Borrower.ABA.number']) {
dwborrow1[i,'Loan.date'] <- dwborrow1[i-1,'Loan.date']+1
}
}
sf2 <- full_join(sf2,dwborrow1[,c('Loan.date','Borrower.ABA.number','Loan.amount','Borrower.state','Term')], by=c('ABA' = 'Borrower.ABA.number', 'Date' = 'Loan.date'))
sf2[is.na(sf2$Original.Outstanding.Advance.Amount),c('Original.Outstanding.Advance.Amount')] <- 0
sf2[is.na(sf2$Loan.amount),c('Loan.amount')] <- 0
keep <- c('Date','size','IDRSSD','reserve_asset_ratio','reserve_loan_ratio','RCON2170','RCON0071','RCON0081','RCON2200','eqcaprat','age','borr_total','FED','exposure','OFFICES', 'aq', 'roe','RCONB529',
'RCFA7204')
temp <- subset(df, as.Date(Date) >= as.Date('2020-03-31'))[,keep]
temp$Date <- as.Date(temp$Date)
sf2$Quarter <- as.Date(quarter(sf2$Date, type='date_first')-1)
sf2 <- left_join(sf2, temp, by=c('RSSD' = 'IDRSSD', 'Quarter' = 'Date'))
setnames(sf2, old=c('InitialApprovalAmount','Original.Outstanding.Advance.Amount', 'Loan.amount'),
new = c('PPP','PPPLF','DW'))
sf2$Reserves <- (sf2$RCON0081 + sf2$RCON0071)*1000
sf2$dwsores <- sf2$DW*100/sf2$RCON2170
sf2$ppp_so_reserves <- sf2$PPP*100/sf2$RCON2170
sf2$ppp_so_reserves <- ifelse(is.na(sf2$ppp_so_reserves) == TRUE, 0, sf2$ppp_so_reserves)
sf2$lfsores <- sf2$PPPLF/sf2$RCON2170
#sf2$delt_so_reserves <- sf2$r_delt*100/sf2$RCON2170
sf2$dwbin_notest <- ifelse(sf2$dwsores > 1, 1,0)
sf2$dwbin_notest <- ifelse(is.na(sf2$dwbin_notest) == TRUE, 0, sf2$dwbin_notest)
sf2$dwsores <- ifelse(sf2$dwbin_notest == 1, sf2$dwsores, 0)
sf2$dw_bin <- ifelse(sf2$DW > 0, 1, 0)
sf2$levratio <- sf2$RCFA7204
sf2$bigsmall <- ifelse(sf2$RCON2170 > 1305000, 1, 0)
sf2$PPPLF_ind <- ifelse(sf2$PPPLF > 0, 1, 0)
sf2$r_delt <- -sf2$PPPLF + sf2$PPP
sf2 <- sf2[order(sf2$RSSD,sf2$Date),]
sf2 <- sf2 %>% group_by(RSSD) %>% mutate(cs_ppp = cumsum(PPP), cs_delt = cumsum(r_delt))
sf2$month <- month(sf2$Date)
sf2$rsa <- sf2$Reserves/sf2$RCON2170
sf2$lsa <- sf2$RCONB529/sf2$RCON2170
sf2$dsa <- sf2$RCON2200/sf2$RCON2170
temp <- aggregate(cbind(size,reserve_asset_ratio) ~ RSSD, sf2, mean) %>% mutate(size_quint = ntile(size,4), shock_quint = ntile(reserve_asset_ratio,5))
sf2 <- left_join(sf2, temp[,c('RSSD','size_quint','shock_quint')], by = 'RSSD')
temp <-aggregate(cbind(PPP,DW,PPPLF) ~ RSSD, sf2, sum)
temp$PPPLF_i <- ifelse(temp$PPPLF > 0, 1, 0)
temp$DW_i <- ifelse(temp$DW > 0, 1, 0)
temp$PPP_i <- ifelse(temp$PPP > 0, 1, 0)
sf2 <- left_join(sf2,temp[,c('RSSD','PPPLF_i','DW_i','PPP_i')])
sf2$State <- coalesce(sf2$STATE, sf2$Borrower.state)
#Create series on whether bank has accessed the LF within the past month
t <- aggregate(cbind(PPPLF_ind,PPPLF) ~ RSSD + Date, sf2, sum) %>% group_by(RSSD) %>% arrange(RSSD, Date)
t <- t %>% group_by(RSSD) %>%
mutate(LF_30i = rollapplyr(PPPLF_ind, width = 30, FUN = sum, partial = TRUE),
LF_30 = rollapplyr(PPPLF, width = 30, FUN = sum, partial = TRUE)) %>%
drop_na()
t$LF_30i <- ifelse(t$LF_30 > 0, 1, 0)
sf2 <- left_join(sf2,t[,c('RSSD','Date','LF_30')],by=c('RSSD','Date'))
sf2$LF_30 <- sf2$LF_30/sf2$Reserves
sf2$LF_30 <- ifelse(is.na(sf2$LF_30) == TRUE, 0, sf2$LF_30)
sf2 <- left_join(sf2,binstr,by=c('RSSD'='IDRSSD','Date'))
# create series on whether bank has used DW 5 years pre-covid
dwborrow1 <- subset(dwborrow, Loan.date >= '2015-04-03' & Loan.date < '2020-04-03')
ls <- intersect(unique(sf2$ABA),unique(dwborrow1$Borrower.ABA.number))
sf2[sf2$ABA %in% ls, 'precovdw'] <- 1
sf2$precovdw <- ifelse(is.na(sf2$precovdw) == TRUE, 0, 1)
# Regressions
sf3 <- subset(sf2, Date >= as.Date('2020-04-03') & Date <= as.Date('2020-08-08'))
sf3 <- sf3[!duplicated(sf3[c("RSSD", "Date")]),]
sf3 <- sf3 %>% drop_na(RSSD, Date, State, size_quint)
sf3 <- sf3[!sf3$Reserves ==0,]
#sf3 <- sf3[!sf3$delt_so_reserves <= 0,]
sf3 <- sf3[rowSums(is.na(sf3)) != ncol(sf3), ]
#stargazer(data.frame(sf3[,c('PPP','PPPLF','PPPLF_i','DW','DW_i','reserve_asset_ratio','OFFICES','eqcaprat','precovdw')])) #summary statistic
dict1 <- c('dw_bin' = 'DW Prob', 'demand_so_reserves' = 'Demand Shock', 'reserve_asset_ratio' = 'RA Ratio',
'size' = 'Size', 'log(PPPLF+1)' = 'Log(PPPLF)', 'log(RCON0010)' = 'Log(Reserves)',
'eqcaprat' = 'Equity Cap Ratio', 'ppp_so_reserves' = 'Demand Shock',
'ppp_so_reserves x PPPLF_ind' = 'DS*PPPLF_ind', 'log(borr_total+1)' = 'Log(FF Borrowing)',
'log(ppp_so_reserves)' = 'Log(Demand Shock)', 'log(PPP)' = 'Log(PPP)',
'dwbin_notest' = 'DW Prob', 'log(reserve_asset_ratio)' = 'Log RA Ratio',
'LF_30' = 'LF_{30}', 'log(eqcaprat)' = 'Log Equity Cap Ratio')
#Table 2: Linear model
t1 <- list()
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + log(reserve_asset_ratio) + size + eqcaprat + rsa + lsa + dsa| RSSD + Date  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
#t1[[3]] <- update(t1[[2]], .~. - log(ppp_so_reserves) - log(ppp_so_reserves)*log(LF_30+1) |.| log(ppp_so_reserves) ~ BInstr)
etable(t1[[3]],stage=1:2)
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,ppp_so_reserves)  + log(LF_30+1) + log(reserve_asset_ratio) + size + eqcaprat + rsa + lsa + dsa| RSSD + Date  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], dwsores ~.)
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,ppp_so_reserves) |.| i(bigsmall,ppp_so_reserves) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~., data = subset(sf, dwsores>0))
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~., data = subset(sf3, dwsores>0))
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + log(reserve_asset_ratio) + size + eqcaprat + rsa + lsa + dsa| RSSD + Date  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~., data = subset(sf3, dwsores>0))
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
#Robustness - Fixed Effects
t6 <- list()
t6[[1]] <- update(t1[[length(t1)]], .~. |. - RSSD - Date)
t6[[2]] <- update(t1[[length(t1)]], .~. |. - RSSD)
t6[[3]] <- update(t1[[length(t1)]], .~. |. - RSSD + FED)
t6[[4]] <- update(t1[[length(t1)]], .~. |. - RSSD + month^State)
t6[[5]] <- update(t1[[length(t1)]], .~. |. - Date + Date^State)
etable(t1[[length(t1)]], t6, dict=dict1, se='cluster', tex=F, cluster= 'RSSD',
drop = c('Intercept','Size', 'eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','precovdw','age','OFFICES'))
# clustering
t3 <- list()
t3[[1]] <- update(t1[[3]], se = 'white')
t3[[2]] <- update(t3[[1]], se = 'cluster', cluster = c('RSSD','Date'))
t3[[3]] <- update(t3[[1]], se = 'cluster', cluster = c('RSSD','month'))
t3[[4]] <- update(t3[[1]], se = 'cluster', cluster = 'FED')
t3[[5]] <- update(t3[[1]], se = 'cluster', cluster = 'State')
etable(t3, dict=dict1, tex=F,
drop = c('eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','Size','exposure'))
#Creating the PPP active indicator
sf2$pactind <- ifelse(sf2$Date < as.Date('2020-04-03'), 0, ifelse(sf2$Date > as.Date('2020-08-08'), 0, ifelse(sf2$Date > as.Date('2020-04-16'), 0,ifelse(sf2$Date < as.Date('2020-04-27'), 0,1))))
sf2[,c('Date','pactind')]
View(sf2)
#Creating the PPP active indicator
sf2$pactind <- ifelse(sf2$Date < as.Date('2020-04-03'), 0, ifelse(sf2$Date > as.Date('2020-08-08'), 0, ifelse(sf2$Date > as.Date('2020-04-16') & sf2$Date < as.Date('2020-04-27'), 0,1)))
sf2$pactind
sf3 <- subset(sf2, Date >= as.Date('2020-04-03') & Date <= as.Date('2020-08-08'))
sf3 <- sf3[!duplicated(sf3[c("RSSD", "Date")]),]
sf3 <- sf3 %>% drop_na(RSSD, Date, State, size_quint)
sf3 <- sf3[!sf3$Reserves ==0,]
#sf3 <- sf3[!sf3$delt_so_reserves <= 0,]
sf3 <- sf3[rowSums(is.na(sf3)) != ncol(sf3), ]
#Table 2: Linear model
t1 <- list()
t1[[1]] <- feols(dwbin_notest ~ i(bigsmall,log(ppp_so_reserves+1))  + log(LF_30+1) + log(reserve_asset_ratio) + size + eqcaprat + rsa + lsa + dsa + pactind| RSSD + Date  ,
sf3, panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], log(dwsores+1) ~.)
t1[[3]] <- update(t1[[2]], . ~. - i(bigsmall,log(ppp_so_reserves+1)) |.| i(bigsmall,log(ppp_so_reserves+1)) ~ i(bigsmall,BInstr) )
etable(t1, dict=dict1,
cluster = 'RSSD', tex = F)
