drop = c('size', 'eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','precovdw','age','OFFICES'))
etable(t1[[length(t1)]], t6, dict=dict1, se='cluster', tex=F, cluster= 'State',
drop = c('Intercept','Size', 'eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','precovdw','age','OFFICES'))
etable(t1[[length(t1)]], t6, dict=dict1, se='cluster', tex=T, cluster= 'State',
drop = c('Intercept','Size', 'eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','precovdw','age','OFFICES'))
matchlb
pppm
pppm <- read_csv("D:/Research/DW lending empirical/Data/ppp_bankmatched.csv")
sod <- read_csv("D:/Research/DW lending empirical/Data/sod_merged.csv")
sod
library(tidyverse)
library(mlr3verse)
library(plm)
library(readxl)
library(dplyr)
library('DataCombine')
library('stargazer')
library('simpleboot')
library('Rpdb')
library('data.table')
library(ggplot2)
library(gtools)
library(lubridate)
library("R.utils")
# For Q4 2009
list <- list.files(path="D:/Research/DW lending empirical/Data/SOD/", pattern=".csv")
sod <- data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/",list[1]),show_col_types = FALSE))
for (i in 2:length(list)) {
sodn <- data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/",list[i]),show_col_types = FALSE))
sod <- smartbind(sod,sodn)
}
base <- left_join(aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDHCR, sod, FUN = sum),
aggregate(DEPSUMBR ~ YEAR + RSSDHCR, sod, FUN = sum), by=c('RSSDHCR', 'YEAR'))
base$dep_share <- base$DEPSUMBR.x/base$DEPSUMBR.y
base <- subset(base, base$RSSDHCR >0)[,c('STALPBR','YEAR','RSSDHCR','dep_share')]
base <- spread(base, STALPBR, dep_share)
base <- left_join(base,sod[,c('RSSDHCR','CERT','YEAR')],by=c('RSSDHCR','YEAR'))
base <- base[!duplicated(base[c("RSSDHCR","YEAR")]),]
base <- smartbind(base,base); base <- smartbind(base,base)
base <- pdata.frame(base,index = c('RSSDHCR','YEAR'))
q <- c("/03/31","/06/30","/09/30","/12/31")
base <- data.frame(base, rep(q,nrow(base)/4))
base$Date <- as.Date(paste0(base$YEAR,base$rep.q..nrow.base..4.))
base <- pdata.frame(data.frame(base),index = c('RSSDHCR','Date'))
base <- base[ , -which(names(base) %in% c("rep.q..nrow.base..4."))]
base <- base[seq(1, nrow(base), 4), ]
for (i in 3:ncol(base)-1){
base[,i] <- lead(base[,i],2)
}
base$Date <- as.Date(base$Date)
base$RSSDHCR <- as.numeric(as.character(base$RSSDHCR))
sci <- data.frame(read_delim("D:/Research/DW lending empirical/Data/SOD/CI/coincident-revised.csv",show_col_types = FALSE))
sci$time <- as.Date(timeLastDayInQuarter(as.Date(sci$Date,'%m/%d/%Y')))
sci <- sci[seq(1, nrow(sci), 3), ][2:ncol(sci)]
list <- names(sci)
for (i in 1:(ncol(sci)-1)) {
sci[,i] <- c(diff(sci[,i]),NA)
}
join <- data.frame(base[,c(1:2,62:63)],
mapply("*", base[intersect(names(base), names(sci))],
sci[intersect(names(base), names(sci))]))
join <- data.frame(join[,1:4], exposure = rowSums(join[5:ncol(join)], na.rm = TRUE))
join <- join[!is.na(join$RSSDHCR),]
list <- match(base$Date, sci$time)
pb = txtProgressBar(min = 0, max = length(list), initial = 0)
a <- vector(length = length(list))
lapply(1:length(list), function(i){
a[i] <- ifelse(is.na(list[i]) == FALSE, sum(base[i,intersect(names(base), names(sci))]*sci[list[i],intersect(names(base), names(sci))], na.rm = TRUE), NA)
setTxtProgressBar(pb,i)})
close(pb)
sod <- smartbind(data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/ALL_2020.csv"),show_col_types = FALSE)),
data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/ALL_2021.csv"),show_col_types = FALSE)))
sod
base <- left_join(aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDHCR, sod, FUN = sum),
aggregate(DEPSUMBR ~ YEAR + RSSDHCR, sod, FUN = sum), by=c('RSSDHCR', 'YEAR'))
base$dep_share <- base$DEPSUMBR.x/base$DEPSUMBR.y
base <- subset(base, base$RSSDHCR >0)[,c('STALPBR','YEAR','RSSDHCR','dep_share')]
base <- spread(base, STALPBR, dep_share)
base <- left_join(base,sod[,c('RSSDHCR','CERT','YEAR')],by=c('RSSDHCR','YEAR'))
base <- base[!duplicated(base[c("RSSDHCR","YEAR")]),]
base
base$Date <- as.Date(base$Date)
base$RSSDHCR <- as.numeric(as.character(base$RSSDHCR))
base
base %>% arrange(RSSSDHCR)
sod <- smartbind(data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/ALL_2020.csv"),show_col_types = FALSE)),
data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/ALL_2021.csv"),show_col_types = FALSE)))
sod
left_join(aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDHCR, sod, FUN = sum),
aggregate(DEPSUMBR ~ YEAR + RSSDHCR, sod, FUN = sum), by=c('RSSDHCR', 'YEAR'))
base <- left_join(aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDHCR, sod, FUN = sum))
base
base <- aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDHCR, sod, FUN = sum)
base
base <- subset(base, RSSDHCR > 0)
base.
base
base %>% group_by(STALPBR) %>% summarise(total_state_dep = sum(DEPSUMBR))
base %>% group_by(STALPBR) %>% mutate(total_state_dep = summarise(total_state_dep = sum(DEPSUMBR)))
base %>% group_by(STALPBR) %>% mutate(total_state_dep =  sum(DEPSUMBR))
base <- base %>% group_by(STALPBR) %>% mutate(total_state_dep =  sum(DEPSUMBR))
base$s_expo <- base$DEPSUMBR/base$total_state_dep
base
pppm
reshape(base, idvar = "RSSDHCR", timevar = "YEAR", direction = "wide")
reshape(base, idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide")
reshape(base[,c('STALPBR','RSSDHCR','s_expo')], idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide")
reshape(base[,c('STALPBR','RSSDHCR','s_expo')], idvar = "RSSDHCR", timevar = "s_expo", direction = "wide")
base
reshape(data.frame(base[,c('STALPBR','RSSDHCR','s_expo')]), idvar = "RSSDHCR", timevar = "s_expo", direction = "wide")
reshape(data.frame(base[,c('STALPBR','RSSDHCR','s_expo')]), idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide")
t1 <- list()
t1[[1]] <- feglm(dwbin_notest ~ ppp_so_reserves + LF_30 | RSSD + Date,
sf3, family = binomial(link = "probit"), panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], .~. + log(reserve_asset_ratio) + size)
t1[[3]] <- update(t1[[2]], .~. + age + OFFICES + log(eqcaprat) + precovdw)
t1[[4]] <- update(t1[[3]], .~. - ppp_so_reserves - LF_30 + ppp_so_reserves*LF_30)
etable(t1[1:4], dict=dict1,
cluster = 'State', tex = T)
#Robustness - clustering
t3 <- list()
t3[[1]] <- update(t1[[length(t1)]], se = 'white')
t3[[2]] <- update(t3[[1]], se = 'cluster', cluster = 'RSSD')
t3[[3]] <- update(t3[[1]], se = 'cluster', cluster = 'State')
t3[[4]] <- update(t3[[1]], se = 'cluster', cluster = 'FED')
t3[[5]] <- update(t3[[1]], se = 'cluster', cluster = 'size_quint')
etable(t3, dict=dict1, tex=T,
drop = c('eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','Size','exposure'))
#Robustness - Fixed Effects
t6 <- list()
t6[[1]] <- update(t1[[length(t1)]], .~. |. - RSSD - Date)
t6[[2]] <- update(t1[[length(t1)]], .~. |. - RSSD)
t6[[3]] <- update(t1[[length(t1)]], .~. |. - RSSD + FED)
t6[[4]] <- update(t1[[length(t1)]], .~. |. - RSSD + State)
etable(t1[[length(t1)]], t6, dict=dict1, se='cluster', tex=T, cluster= 'State',
drop = c('Intercept','Size', 'eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','precovdw','age','OFFICES'))
etable(t1[1:4], dict=dict1,
cluster = 'State', tex = F)
etable(t3, dict=dict1, tex=F,
drop = c('eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','Size','exposure'))
etable(t1[[length(t1)]], t6, dict=dict1, se='cluster', tex=F, cluster= 'State',
drop = c('Intercept','Size', 'eqcaprat','RA Ratio','Asset','Equity','FF Borrowing','precovdw','age','OFFICES'))
t1[[1]] <- feglm(dwbin_notest ~ LF_30 | RSSD + Date | ppp_so_reserves ~ PPP,
sf3, family = binomial(link = "probit"), panel.id = c('RSSD','Date'))
base <- reshape(data.frame(base[,c('STALPBR','RSSDHCR','s_expo')]), idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide")
base
base[,1]
colnames(base)
sub('s_expo.',"",colnames(base))
colnames(base) <- sub('s_expo.',"",colnames(base))
base
pppm
matchlb
View(pppm)
# Import
list <- list.files(path="D:/Research/DW lending empirical/Data/ppp_sba/", pattern=".csv")
dfp <- read_delim(paste0("D:/Research/DW lending empirical/Data/ppp_sba/",list[1]), show_col_types = FALSE)
for (i in 2:length(list)){
dfpn <- read_delim(paste0("D:/Research/DW lending empirical/Data/ppp_sba/",list[i]), show_col_types = FALSE)
dfp <- bind_rows(dfp,dfpn) %>% select(-contains("..."))
print(i)
}
dfp
# Import
list <- list.files(path="D:/Research/DW lending empirical/Data/ppp_sba/", pattern=".csv")
dfp <- read_delim(paste0("D:/Research/DW lending empirical/Data/ppp_sba/",list[1]), show_col_types = FALSE)
for (i in 2:length(list)){
dfpn <- read_delim(paste0("D:/Research/DW lending empirical/Data/ppp_sba/",list[i]), show_col_types = FALSE)
dfp <- bind_rows(dfp,dfpn)
print(i)
}
rm(dfpn)
dfp$DateApproved <- as.Date(dfp$DateApproved,'%m/%d/%Y')
dfp
dfp
aggregate(InitialApprovalAmount ~ DateApproved + OriginatingLenderState,dfp)
aggregate(InitialApprovalAmount ~ DateApproved + OriginatingLenderState,dfp, sum)
b2 <- aggregate(InitialApprovalAmount ~ DateApproved + OriginatingLenderState,dfp, sum)
reshape(b2, idvar = "DateApproved", timevar = "OriginatingLenderState", direction = "wide")
b2 <- reshape(b2, idvar = "DateApproved", timevar = "OriginatingLenderState", direction = "wide")
colnames(b2) <- sub('InitialApprovalAmount.',"",colnames(b2))
b2
base
data.frame(IDRSSD = base$RSSDHCR, Date = b2$DateApproved)
data.frame(IDRSSD = rep(base$RSSDHCR, length(b2$DateApproved)), Date = b2$DateApproved)
length(b2$DateApproved)
base$RSSDHCR
nf <- data.frame(IDRSSD = rep(unique(base$RSSDHCR), length(b2$DateApproved)), Date = b2$DateApproved)
3901*247
View(base)
View(nf)
nf <- nf[order(nf$IDRSSD,nf$Date),]
base
base <- aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDHCR, sod, FUN = sum)
base <- subset(base, RSSDHCR > 0)
base <- base %>% group_by(STALPBR) %>% mutate(total_state_dep =  sum(DEPSUMBR))
base$s_expo <- base$DEPSUMBR/base$total_state_dep
base <- reshape(data.frame(base[,c('STALPBR','RSSDHCR','s_expo')]), idvar = c("RSSDHCR",'YEAR'), timevar = "STALPBR", direction = "wide")
base <- reshape(data.frame(base[,c('STALPBR','RSSDHCR','s_expo')]), v.names = 's_expo', idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide")
base
base <- aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDHCR, sod, FUN = sum)
base <- subset(base, RSSDHCR > 0)
base <- base %>% group_by(STALPBR) %>% mutate(total_state_dep =  sum(DEPSUMBR))
base$s_expo <- base$DEPSUMBR/base$total_state_dep
base
reshape(data.frame(base[base$YEAR == 2020,c('STALPBR','RSSDHCR','s_expo')]), v.names = 's_expo', idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide")
bb1 <- reshape(data.frame(base[base$YEAR == 2020,c('STALPBR','RSSDHCR','s_expo')]), v.names = 's_expo', idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide")
bb2 <- reshape(data.frame(base[base$YEAR == 2021,c('STALPBR','RSSDHCR','s_expo')]), v.names = 's_expo', idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide")
colnames(bb1) <- sub('s_expo.',"",colnames(bb1)); colnames(bb2) <- sub('s_expo.',"",colnames(bb2));
bb1
bb2
base <- smartbind(bb1,bb2)
rm(bb1, bb2)
base
base <- aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDHCR, sod, FUN = sum)
base <- subset(base, RSSDHCR > 0)
base <- base %>% group_by(STALPBR) %>% mutate(total_state_dep =  sum(DEPSUMBR))
base$s_expo <- base$DEPSUMBR/base$total_state_dep
bb1 <- reshape(data.frame(base[base$YEAR == 2020,c('STALPBR','RSSDHCR','s_expo')]), v.names = 's_expo', idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide"); bb1$YEAR <- 2020
bb2 <- reshape(data.frame(base[base$YEAR == 2021,c('STALPBR','RSSDHCR','s_expo')]), v.names = 's_expo', idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide"); bb2$YEAR <- 2021
colnames(bb1) <- sub('s_expo.',"",colnames(bb1)); colnames(bb2) <- sub('s_expo.',"",colnames(bb2));
base <- smartbind(bb1,bb2); rm(bb1, bb2)
base
nf
b2
b2$YEAR <- year(b2$DateApproved)
b2
nf <- left_join(nf, b2, by=c('Date'='DateApproved'))
nf
base
nf
nf[intersect(names(base), names(nf))]
base
nf2 <- data.frame(IDRSSD = rep(unique(base$RSSDHCR), length(b2$DateApproved)), Date = b2$DateApproved)
nf <- nf[order(nf$IDRSSD,nf$Date),]; nf2 <- nf2[order(nf2$IDRSSD,nf2$Date),];
nf
nf2
base
nf2 <- left_join(nf2, base, by=c('IDRSSD' = 'RSSDHCR'))
nf2
nf
b2
table(b2$YEAR)
nf2
subset(nf2, year(Date) = year(YEAR))
subset(nf2, year(Date) == year(YEAR))
year(nf2$Date)
year(nf2$YEAR)
subset(nf2, year(Date) == YEAR)
nf2 <- subset(nf2, year(Date) == YEAR)
nf
unique(nf$IDRSSD)
length(unique(nf$IDRSSD))
length(unique(nf2$IDRSSD))
length(unique(nf2$Date))
length(unique(nf$Date))
View(nf2)
nf[!(paste(nf$IDRSSD,nf$Date) %in% paste(nf2$IDRSSD,nf2$Date)),]
paste(nf$IDRSSD,nf$Date)
nf[!(paste0(nf$IDRSSD,nf$Date) %in% paste0(nf2$IDRSSD,nf2$Date)),]
nf[!(nf$IDRSSD %in% nf2$IDRSSD)&(nf$Date %in% nf2$Date),]
nf$idn <- paste0(nf$IDRSSD,nf$Date); nf2$idn <- paste0(nf2$IDRSSD,nf2$Date)
nf <- data.frame(IDRSSD = rep(unique(base$RSSDHCR), length(b2$DateApproved)), Date = b2$DateApproved)
nf2 <- data.frame(IDRSSD = rep(unique(base$RSSDHCR), length(b2$DateApproved)), Date = b2$DateApproved)
nf <- nf[order(nf$IDRSSD,nf$Date),]; nf2 <- nf2[order(nf2$IDRSSD,nf2$Date),]
nf <- left_join(nf, b2, by=c('Date'='DateApproved')); nf2 <- left_join(nf2, base, by=c('IDRSSD' = 'RSSDHCR'))
nf2 <- subset(nf2, year(Date) == YEAR)
nf[(paste0(nf$IDRSSD,nf$Date) %in% paste0(nf2$IDRSSD,nf2$Date)),]
nf <- nf[(paste0(nf$IDRSSD,nf$Date) %in% paste0(nf2$IDRSSD,nf2$Date)),]
nf[intersect(names(nf), names(nf2))]
nf[intersect(names(nf2), names(nf))]
nf
nf[intersect(names(nf), names(nf2))
]
intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))
nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))]
nf[intersect(names(nf2), names(nf[,3:(ncol(nf2)-1)]))]
nf[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))]
mapply("*", nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))],
nf[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))])
nf
nf2
nf[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))]
nf2[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))]
mapply("*", nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))],
nf2[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))])
data.frame(nf[1:2] ,mapply("*", nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))],
nf2[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))]))
nf1 <- data.frame(nf[1:2] ,mapply("*", nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))],
nf2[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))]))
nf1
rowSums(nf1[3:ncol(nf1)])
rowSums(nf1[,3:ncol(nf1)])
rowSums(nf1[,3:ncol(nf1)], na.rm=TRUE)
nf1$BInstr <- rowSums(nf1[,3:ncol(nf1)], na.rm=TRUE)
nf1
nf1 <- nf1[,c('IDRSSD','Date','BInstr')]
nf1
sod
sod$RSSDHCR
unique(sod$RSSDHCR)
order(unique(sod$RSSDHCR))
unique(sod$RSSDHCR)[order(unique(sod$RSSDHCR))]
sod$CERT
left_join(nf1, sod[,c('RSSDHCR','CERT')], by=c('IDRSSD' = 'RSSDHCR'))
nf1 <- left_join(nf1, sod[,c('RSSDHCR','CERT')], by=c('IDRSSD' = 'RSSDHCR'))
sf2
write.csv(nf1,"D:\\Research\\DW lending empirical\\Data\\binstr.csv")
binstr <- read_csv("D:/Research/DW lending empirical/Data/binstr.csv")
rm(nf,nf1,nf2)
rm(base,b2,crdat)
binstr
rm(binstr)
sod <- smartbind(data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/ALL_2020.csv"),show_col_types = FALSE)),
data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/ALL_2021.csv"),show_col_types = FALSE)))
base <- aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDHCR, sod, FUN = sum)
base <- subset(base, RSSDHCR > 0)
base <- base %>% group_by(STALPBR) %>% mutate(total_state_dep =  sum(DEPSUMBR))
base$s_expo <- base$DEPSUMBR/base$total_state_dep
bb1 <- reshape(data.frame(base[base$YEAR == 2020,c('STALPBR','RSSDHCR','s_expo')]), v.names = 's_expo', idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide"); bb1$YEAR <- 2020
bb2 <- reshape(data.frame(base[base$YEAR == 2021,c('STALPBR','RSSDHCR','s_expo')]), v.names = 's_expo', idvar = "RSSDHCR", timevar = "STALPBR", direction = "wide"); bb2$YEAR <- 2021
colnames(bb1) <- sub('s_expo.',"",colnames(bb1)); colnames(bb2) <- sub('s_expo.',"",colnames(bb2));
base <- smartbind(bb1,bb2); rm(bb1, bb2)
b2 <- aggregate(InitialApprovalAmount ~ DateApproved + OriginatingLenderState,dfp, sum)
b2 <- reshape(b2, idvar = "DateApproved", timevar = "OriginatingLenderState", direction = "wide")
colnames(b2) <- sub('InitialApprovalAmount.',"",colnames(b2))
b2$YEAR <- year(b2$DateApproved)
nf <- data.frame(IDRSSD = rep(unique(base$RSSDHCR), length(b2$DateApproved)), Date = b2$DateApproved)
nf2 <- data.frame(IDRSSD = rep(unique(base$RSSDHCR), length(b2$DateApproved)), Date = b2$DateApproved)
nf <- nf[order(nf$IDRSSD,nf$Date),]; nf2 <- nf2[order(nf2$IDRSSD,nf2$Date),]
nf <- left_join(nf, b2, by=c('Date'='DateApproved')); nf2 <- left_join(nf2, base, by=c('IDRSSD' = 'RSSDHCR'))
nf2 <- subset(nf2, year(Date) == YEAR)
nf <- nf[(paste0(nf$IDRSSD,nf$Date) %in% paste0(nf2$IDRSSD,nf2$Date)),]
nf1 <- data.frame(nf[1:2] ,mapply("*", nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))],
nf2[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))]))
nf1$BInstr <- rowSums(nf1[,3:ncol(nf1)], na.rm=TRUE)
nf1 <- nf1[,c('IDRSSD','Date','BInstr')]
nf1 <- left_join(nf1, unique(sod[,c('RSSDHCR','CERT')]), by=c('IDRSSD' = 'RSSDHCR'))
write.csv(nf1,"D:\\Research\\DW lending empirical\\Data\\binstr.csv")
rm(base,b2,nf,nf2,nf1)
binstr <- read_csv("D:/Research/DW lending empirical/Data/binstr.csv")
left_join(sf2,binstr)
left_join(sf2,binstr,by=c('RSSD'='IDRSSD','Date'))
sf2 <- left_join(sf2,binstr,by=c('RSSD'='IDRSSD','Date'))
sf2$BInstr
descr(sf2$BInstr)
pppm <- read_csv("D:/Research/DW lending empirical/Data/ppp_bankmatched.csv")
sod <- smartbind(data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/ALL_2020.csv"),show_col_types = FALSE)),
data.frame(read_delim(paste0("D:/Research/DW lending empirical/Data/SOD/ALL_2021.csv"),show_col_types = FALSE)))
base <- aggregate(DEPSUMBR ~ STALPBR + YEAR + RSSDID, sod, FUN = sum)
base <- subset(base, RSSDID > 0)
base <- base %>% group_by(STALPBR) %>% mutate(total_state_dep =  sum(DEPSUMBR))
base$s_expo <- base$DEPSUMBR/base$total_state_dep
bb1 <- reshape(data.frame(base[base$YEAR == 2020,c('STALPBR','RSSDID','s_expo')]), v.names = 's_expo', idvar = "RSSDID", timevar = "STALPBR", direction = "wide"); bb1$YEAR <- 2020
bb2 <- reshape(data.frame(base[base$YEAR == 2021,c('STALPBR','RSSDID','s_expo')]), v.names = 's_expo', idvar = "RSSDID", timevar = "STALPBR", direction = "wide"); bb2$YEAR <- 2021
colnames(bb1) <- sub('s_expo.',"",colnames(bb1)); colnames(bb2) <- sub('s_expo.',"",colnames(bb2));
base <- smartbind(bb1,bb2); rm(bb1, bb2)
b2 <- aggregate(InitialApprovalAmount ~ DateApproved + OriginatingLenderState,dfp, sum)
b2 <- reshape(b2, idvar = "DateApproved", timevar = "OriginatingLenderState", direction = "wide")
colnames(b2) <- sub('InitialApprovalAmount.',"",colnames(b2))
b2$YEAR <- year(b2$DateApproved)
nf <- data.frame(IDRSSD = rep(unique(base$RSSDID), length(b2$DateApproved)), Date = b2$DateApproved)
nf2 <- data.frame(IDRSSD = rep(unique(base$RSSDID), length(b2$DateApproved)), Date = b2$DateApproved)
nf <- nf[order(nf$IDRSSD,nf$Date),]; nf2 <- nf2[order(nf2$IDRSSD,nf2$Date),]
nf <- left_join(nf, b2, by=c('Date'='DateApproved')); nf2 <- left_join(nf2, base, by=c('IDRSSD' = 'RSSDID'))
nf2 <- subset(nf2, year(Date) == YEAR)
nf <- nf[(paste0(nf$IDRSSD,nf$Date) %in% paste0(nf2$IDRSSD,nf2$Date)),]
nf1 <- data.frame(nf[1:2] ,mapply("*", nf[intersect(names(nf), names(nf2[,3:(ncol(nf2)-1)]))],
nf2[intersect(names(nf2), names(nf[,3:(ncol(nf)-1)]))]))
nf1$BInstr <- rowSums(nf1[,3:ncol(nf1)], na.rm=TRUE)
nf1 <- nf1[,c('IDRSSD','Date','BInstr')]
nf1 <- left_join(nf1, unique(sod[,c('RSSDID','CERT')]), by=c('IDRSSD' = 'RSSDID'))
write.csv(nf1,"D:\\Research\\DW lending empirical\\Data\\binstr.csv")
rm(base,b2,nf,nf2,nf1)
binstr <- read_csv("D:/Research/DW lending empirical/Data/binstr.csv")
temp <- subset(df, as.Date(Date) == as.Date('2020-03-31'))
ls <- unique(data.frame(IDRSSD = df$IDRSSD, ABA = df$Primary.ABA.Routing.Number, STATE = df$Financial.Institution.State))
ls <- unique(smartbind(ls,data.frame(att)))
sf2 <- aggregate(InitialApprovalAmount ~ rssd + DateApproved, pppm, sum)
sf2 <- full_join(sf2, unique(df[,c('IDRSSD','Primary.ABA.Routing.Number')]), by=c('rssd' = 'IDRSSD'))
sf2 <- left_join(sf2, ls, by=c('rssd' = 'IDRSSD'))
sf2$ABA <- coalesce(sf2$Primary.ABA.Routing.Number, sf2$ABA)
sf2 <- data.frame(RSSD = sf2$rssd, Date = sf2$DateApproved, ABA = sf2$ABA, State = sf2$STATE, PPP = sf2$InitialApprovalAmount)
sf2 <- full_join(sf2,
left_join(data.frame(aggregate(Original.Outstanding.Advance.Amount ~ Institution.RSSD + Date.Of.Advance, pplf, sum)),
pplf[,c('Institution.RSSD', 'Date.Of.Advance', 'origin_date')]),
by=c('RSSD' = 'Institution.RSSD', 'Date' = 'Date.Of.Advance'))
dwborrow1 <- dwborrow
dwborrow1$Borrower.ABA.number <- as.numeric(dwborrow1$Borrower.ABA.number)
dwborrow1 <- subset(dwborrow1,Loan.date >= as.Date('2020-04-03') & Loan.date <= as.Date('2020-08-08'))
sf2 <- full_join(sf2,dwborrow1[,c('Loan.date','Borrower.ABA.number','Loan.amount','Borrower.state')], by=c('ABA' = 'Borrower.ABA.number', 'Date' = 'Loan.date'))
sf2[is.na(sf2$Original.Outstanding.Advance.Amount),c('Original.Outstanding.Advance.Amount')] <- 0
sf2[is.na(sf2$Loan.amount),c('Loan.amount')] <- 0
sf2[is.na(sf2$PPP) == TRUE, 'PPP'] <- 0
sf2 <- sf2[!is.na(sf2$Date),]
sf2[is.na(sf2$ABA) == TRUE,'ABA'] <- ls[match(sf2[is.na(sf2$ABA) == TRUE,'RSSD'],ls$IDRSSD),'ABA']
sf2[is.na(sf2$RSSD) == TRUE,'RSSD'] <- ls[match(sf2[is.na(sf2$RSSD) == TRUE,'ABA'],ls$ABA),'IDRSSD']
keep <- c('Date','size','IDRSSD','reserve_asset_ratio','reserve_loan_ratio','RCON0071','RCON0081','eqcaprat','age','borr_total','FED','exposure','OFFICES', 'aq', 'roe','RCONB529','RCON2170')
temp <- subset(df, as.Date(Date) >= as.Date('2020-03-31'))[,keep]
temp$Date <- as.Date(temp$Date)
sf2$Quarter <- as.Date(quarter(sf2$Date, type='date_first')-1)
sf2 <- left_join(sf2, temp, by=c('RSSD' = 'IDRSSD', 'Quarter' = 'Date'))
setnames(sf2, old=c('Original.Outstanding.Advance.Amount', 'Loan.amount'),
new = c('PPPLF','DW'))
sf2$Reserves <- (sf2$RCON0081+sf2$RCON0071)*1000
sf2$loan_share_asset <- sf2$RCONB529/sf2$RCON2170
sf2$dw_so_res <- sf2$DW/sf2$Reserves
sf2$dwbin_notest <- ifelse(sf2$dw_so_res > .01, 1,0)
sf2$dwbin_notest <- ifelse(is.na(sf2$dwbin_notest) == TRUE, 0, sf2$dwbin_notest)
sf2$dw_bin <- ifelse(sf2$DW > 0, 1, 0)
#sf2$dw_bin <- ifelse(is.na(sf2$dw_bin) == FALSE, sf2$dw_bin, 0)
sf2$PPPLF_ind <- ifelse(sf2$PPPLF > 0, 1, 0)
sf2$r_delt <- -sf2$PPPLF + sf2$PPP
sf2 <- sf2[order(sf2$RSSD,sf2$Date),]
sf2 <- sf2 %>% group_by(RSSD) %>% mutate(cs_ppp = cumsum(PPP), cs_delt = cumsum(r_delt))
sf2$month <- month(sf2$Date)
sf2$cs_ppp <- sf2$cs_ppp/sf2$Reserves
sf2$ppp_so_reserves <- sf2$PPP/sf2$Reserves
sf2$ppp_so_reserves <- ifelse(is.na(sf2$ppp_so_reserves) == TRUE, 0, sf2$ppp_so_reserves)
sf2$delt_so_reserves <- sf2$r_delt/sf2$Reserves
temp <- aggregate(cbind(size,reserve_asset_ratio) ~ RSSD, sf2, mean) %>% mutate(size_quint = ntile(size,50), ra_quint = ntile(reserve_asset_ratio,5))
sf2 <- left_join(sf2, temp[,c('RSSD','size_quint','ra_quint')], by = 'RSSD')
temp <-aggregate(cbind(PPP,DW,PPPLF) ~ RSSD, sf2, sum)
temp$PPPLF_i <- ifelse(temp$PPPLF > 0, 1, 0)
temp$DW_i <- ifelse(temp$DW > 0, 1, 0)
temp$PPP_i <- ifelse(temp$PPP > 0, 1, 0)
sf2 <- left_join(sf2,temp[,c('RSSD','PPPLF_i','DW_i','PPP_i')])
sf2$State <- coalesce(sf2$State, sf2$Borrower.state)
#Create series on whether bank has accessed the LF within the past month
t <- aggregate(PPPLF_ind ~ RSSD + Date, sf2, sum) %>% group_by(RSSD) %>% arrange(RSSD, Date)
t <- t %>% group_by(RSSD) %>%
complete(Date = full_seq(Date, period = 1), fill = list(PPPLF_ind = 0)) %>%
mutate(LF_30 = rollapplyr(PPPLF_ind, width = 30, FUN = sum, partial = TRUE)) %>%
drop_na()
t$LF_30 <- ifelse(t$LF_30 > 0, 1, 0)
sf2 <- left_join(sf2,t[,c('RSSD','Date','LF_30')],by=c('RSSD','Date'))
sf2 <- left_join(sf2,binstr,by=c('RSSD'='IDRSSD','Date'))
# create series on whether bank has used DW 5 years pre-covid
dwborrow1 <- subset(dwborrow, Loan.date >= '2015-04-03' & Loan.date < '2020-04-03')
ls <- intersect(unique(sf2$ABA),unique(dwborrow1$Borrower.ABA.number))
sf2[sf2$ABA %in% ls, 'precovdw'] <- 1
sf2$precovdw <- ifelse(is.na(sf2$precovdw) == TRUE, 0, 1)
#Creating the shift share instrument
#Why instrument?
#share - total PPP loans lent out by state and day, shift - daily change in PPP lending size total
sbydate <- aggregate(cbind(n,InitialApprovalAmount) ~ OriginatingLenderState + DateApproved, subset(pppm, DateApproved <= '2020-08-08'), sum)
# Regressions
sf3 <- subset(sf2, Date >= as.Date('2020-04-03') & Date <= as.Date('2020-08-08'))
sf3 <- sf3[!duplicated(sf3[c("RSSD", "Date")]),]
sf3 <- sf3 %>% drop_na(RSSD, Date, State, size_quint)
sf3$BInstr
feols(ppp_so_reserves ~ BInstr, sf3)
feols(ppp_so_reserves ~ log(BInstr), sf3)
t1 <- list()
t1[[1]] <- feglm(dwbin_notest ~ppp_so_reserves + LF_30 | RSSD + Date,
sf3, family = binomial(link = "probit"), panel.id = c('RSSD','Date'))
t1[[2]] <- update(t1[[1]], .~. + log(reserve_asset_ratio) + size)
t1[[3]] <- update(t1[[2]], .~. + age + OFFICES + log(eqcaprat) + precovdw)
t1[[4]] <- update(t1[[3]], .~. - ppp_so_reserves - LF_30 + ppp_so_reserves*LF_30)
etable(t1[1:4], dict=dict1,
cluster = 'State', tex = F)
t2[[2]] <- update(t1[[length(t1)]], -ppp_so_reserves|. |ppp_so_reserves ~ log(BInstr),family = gaussian())
etable(t1[[length(t1)]],t2, dict=dict1, cluster = 'State', tex=F,
drop = c('eqcaprat','RA Ratio','Asset','Equity','FF Borrowing'))
t2[[2]] <- update(t1[[length(t1)]],.~. -ppp_so_reserves|. |ppp_so_reserves ~ log(BInstr),family = gaussian())
etable(t1[[length(t1)]],t2, dict=dict1, cluster = 'State', tex=F,
drop = c('eqcaprat','RA Ratio','Asset','Equity','FF Borrowing'))
feols(dwbin_notest ~ LF_30 + + log(reserve_asset_ratio) + size |  RSSD + Date| ppp_so_reserves ~ log(BInstr),
sf3, panel.id = c('RSSD','Date'))
feols(dwbin_notest ~ LF_30 + log(reserve_asset_ratio) + size |  RSSD + Date| ppp_so_reserves ~ log(BInstr),
sf3, panel.id = c('RSSD','Date'))
feols(ppp_so_reserves ~ log(BInstr), sf3)
install.packages('ivprobit')
library('ivprobit')
ivprobit(dwbin_notest ~ LF_30 + log(reserve_asset_ratio) + size |  RSSD + Date| ppp_so_reserves ~ log(BInstr),
sf3, panel.id = c('RSSD','Date'))
ivprobit(dwbin_notest ~ LF_30 + log(reserve_asset_ratio) + size |  RSSD + Date| ppp_so_reserves ~ log(BInstr),
sf3)
pdata.frame(sf3, index=c('RSSD','Date'))
ivprobit(dwbin_notest ~ LF_30 + log(reserve_asset_ratio) + size | ppp_so_reserves|  log(BInstr),
)
ivprobit(dwbin_notest ~ LF_30 + log(reserve_asset_ratio) + size | ppp_so_reserves|log(BInstr), pdata.frame(sf3, index=c('RSSD','Date'))
)
ivprobit(dwbin_notest ~ LF_30 + log(reserve_asset_ratio) + size | ppp_so_reserves| log(BInstr), pdata.frame(sf3, index=c('RSSD','Date')))
ivprobit(dwbin_notest ~ LF_30 + log(reserve_asset_ratio) + size + i(Date) + i(RSSD) | ppp_so_reserves| log(BInstr), pdata.frame(sf3, index=c('RSSD','Date')))
rm(fix,ran,binstr,dfp,dwborrow,dwborrow,join,matchlb)
rm(r1,sci,sod,sodn,t)
gc()
t <- ivprobit(dwbin_notest ~ LF_30 + log(reserve_asset_ratio) + size + i(Date) + i(RSSD) | ppp_so_reserves| log(BInstr), pdata.frame(sf3, index=c('RSSD','Date')))
t <- ivprobit(dwbin_notest ~ log(reserve_asset_ratio) + size + i(Date) + i(RSSD) |ppp_so_reserves| log(BInstr), sf3)
sf3
descr(sf3$BInstr)
write.csv(sf3,"D:\\Research\\DW lending empirical\\Data\\reg_data.csv")
save.image("D:/Research/DW lending empirical/Code/dw_empirical/.RData")
feols(ppp_so_reserves ~ (BInstr/Reserves), sf3)
feols(ppp_so_reserves ~ BInstr/Reserves, sf3)
feols(ppp_so_reserves ~ log(BInstr),sf3)
feols(ppp_so_reserves ~ log(BInstr)| RSSD + Date,sf3)
sf3$in <- sf3$BInstr/sf3$Reserves
sf3$ins <- sf3$BInstr/sf3$Reserves
feols(ppp_so_reserves ~ ins + LF_30  + log(reserve_asset_ratio) + size + age + OFFICES + log(eqcaprat) + precovdw | RSSD + Date, sf3)
t1[[5]] <- feols(ppp_so_reserves ~ ins + LF_30  + log(reserve_asset_ratio) + size + age + OFFICES + log(eqcaprat) + precovdw | RSSD + Date, sf3)
t1[[5]]$fixef_vars
t1[[5]]$fitted.values
sf4 <- data.frame(sf3[t1[[5]]$obs_selection$obsRemoved],pred = t1[[5]]$fitted.values)
sf4 <- data.frame(sf3[t1[[5]]$obs_selection$obsRemoved,],pred = t1[[5]]$fitted.values)
feglm(dwbin_notest ~ pred + LF_30  + log(reserve_asset_ratio) + size + age + OFFICES + log(eqcaprat) + precovdw | RSSD + Date, sf4, family = binomial(link = "probit"))
feglm(dwbin_notest ~ pred + LF_30  + log(reserve_asset_ratio) + size + age + OFFICES + log(eqcaprat) + precovdw | RSSD + Date, sf4, family = binomial(link = "probit"), se = 'white')
t1[[5]] <- feols(ppp_so_reserves ~ ins + LF_30  + log(reserve_asset_ratio) + size + age + OFFICES + log(eqcaprat) + precovdw | State + Date, sf3)
sf4 <- data.frame(sf3[t1[[5]]$obs_selection$obsRemoved,],pred = t1[[5]]$fitted.values)
feglm(dwbin_notest ~ pred + LF_30  + log(reserve_asset_ratio) + size + age + OFFICES + log(eqcaprat) + precovdw | state + Date, sf4, family = binomial(link = "probit"), se = 'white')
feglm(dwbin_notest ~ pred + LF_30  + log(reserve_asset_ratio) + size + age + OFFICES + log(eqcaprat) + precovdw | State + Date, sf4, family = binomial(link = "probit"), se = 'white')
